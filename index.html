<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="icon" href="Z.png" type="image/x-icon">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover, shrink-to-fit=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<title>ZENU HUB Editor</title>

<!-- Firebase Legacy SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg-dark: #050505; 
  --bg-panel: #111111; 
  --bg-header: rgba(0, 0, 0, 0.95);
  --accent: #ff0000; 
  --accent-dim: #990000;
  --text-main: #ffffff; 
  --text-dim: #888888; 
  --border: #333333; 
}

html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-dark); overflow: hidden; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; -webkit-text-size-adjust: 100%; touch-action: none; }

/* Animations */
@keyframes slideDownHeader { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideUpToast { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Neon Pulse */
@keyframes neonPulse {
  0%, 100% { text-shadow: 0 0 5px rgba(255, 0, 0, 0.6), 0 0 10px rgba(255, 0, 0, 0.3); opacity: 0.95; }
  50% { text-shadow: 0 0 10px #ff0000, 0 0 20px rgba(255, 0, 0, 0.5); opacity: 1; filter: brightness(1.1); }
}

/* Directional Animations */
.anim-next-out { animation: slideOutToLeft 0.2s forwards; } .anim-next-in { animation: slideInFromRight 0.2s forwards; }
.anim-prev-out { animation: slideOutToRight 0.2s forwards; } .anim-prev-in { animation: slideInFromLeft 0.2s forwards; }
@keyframes slideOutToLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-30px); opacity: 0; } }
@keyframes slideInFromRight { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOutToRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(30px); opacity: 0; } }
@keyframes slideInFromLeft { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Layout */
#header { height: 60px; background: var(--bg-header); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #1a1a1a; animation: slideDownHeader 0.7s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1000; }
.brand-container { display: flex; flex-direction: column; justify-content: center; align-items: flex-start; line-height: 1; }
.brand { color: var(--text-main); font-size: 20px; font-weight: 900; letter-spacing: 1px; font-style: italic; animation: neonPulse 2s infinite ease-in-out; }
.brandes { color: var(--accent); font-size: 10px; font-weight: 700; letter-spacing: 6px; margin-left: 2px; animation: neonPulse 2s infinite ease-in-out reverse; }
.controls { display: flex; align-items: center; gap: 8px; }

.header-btn { background: #000; color: var(--text-main); border: 1px solid var(--border); padding: 0 12px; height: 34px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; transition: all 0.2s; text-transform: uppercase; white-space: nowrap; }
.header-btn:hover { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); }
#auth-btn { background: #1a1a1a; border-color: #333; }

.zoom-group { display: flex; gap: 4px; background: #000; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
.zoom-btn { background: transparent; color: #fff; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.zoom-btn:hover { background: #333; color: var(--accent); }

#tab-bar { height: 42px; background: #080808; display: flex; align-items: center; border-bottom: 1px solid #222; overflow-x: auto; scrollbar-width: none; position: relative; scroll-behavior: smooth; }
#tab-bar::-webkit-scrollbar { display: none; }
#tabs-container { display: flex; height: 100%; position: relative; }
.tab { height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 10px 0 18px; color: var(--text-dim); font-size: 12px; cursor: pointer; background: transparent; border-right: 1px solid rgba(255,255,255,0.05); min-width: 120px; max-width: 220px; user-select: none; transition: all 0.3s; position: relative; z-index: 2; font-family: 'Segoe UI', sans-serif; }
.tab:hover { color: #fff; background: rgba(255,255,255,0.02); }
.tab.active { color: #fff; background: rgba(255, 0, 0, 0.05); }
.tab-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 8px; font-weight: 500; }
.tab-options-btn { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #555; transition: 0.2s; flex-shrink: 0; }
.tab-options-btn:hover { background: var(--accent); color: #fff; }
#tab-indicator { position: absolute; bottom: 0; height: 2px; background: var(--accent); box-shadow: 0 -2px 10px var(--accent); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; }
#add-tab-btn { padding: 0 16px; height: 100%; background: transparent; border: none; color: #555; font-size: 24px; cursor: pointer; transition: 0.3s; z-index: 10; }
#add-tab-btn:hover { color: var(--accent); transform: scale(1.1); text-shadow: 0 0 10px var(--accent); }

#container-viewport { width: 100%; height: calc(100% - 102px); background: var(--bg-dark); overflow: hidden; position: relative; }
#container { width: 100%; height: 100%; }

/* Version Indicator */
#version-tag { position: fixed; bottom: 5px; right: 10px; color: #333; font-size: 10px; font-weight: bold; pointer-events: none; z-index: 9999; opacity: 0.5; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(5px); }
.modal-box { background: #0a0a0a; width: 300px; padding: 30px; border-radius: 16px; border: 1px solid #333; box-shadow: 0 0 40px rgba(255,0,0,0.1); }
.modal-box h3 { margin: 0 0 25px; font-size: 18px; text-align: center; color: #fff; font-weight: 900; letter-spacing: 1px; }
.modal-box input { width: 100%; box-sizing: border-box; padding: 14px; margin-bottom: 15px; background: #151515; border: 1px solid #333; color: #fff; border-radius: 8px; outline: none; transition: 0.3s; }
.modal-box input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(255,0,0,0.2); }

#tab-menu { position: fixed; background: #111; border: 1px solid #333; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); padding: 6px; min-width: 180px; z-index: 10001; display: none; }
.menu-item { padding: 10px 14px; color: #eee; font-size: 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
.menu-item:hover { background: var(--accent); color: #fff; }
.menu-item.danger:hover { background: #ff3b30; }

.monaco-editor .scroll-decoration { display: none; }
.monaco-editor .slider { background: #333 !important; border-radius: 4px !important; }
.monaco-editor .slider:hover { background: #555 !important; }
input, textarea { font-size: 16px !important; }
@viewport { width: device-width; zoom: 1.0; }
</style>
</head>

<body>
<div id="header">
    <div class="brand-container">
        <div class="brand">ZENU</div>
        <div class="brandes">HUB</div>
    </div>
    
    <div class="controls">
        <button id="auth-btn" class="header-btn" onclick="window.handleAccountAction()"><span>ðŸ‘¤</span> LOGIN</button>
        <button id="install-app-btn" class="header-btn" title="INSTALL"><span>ðŸ“¥</span> INSTALL</button>
        <div class="zoom-group">
            <button class="zoom-btn" id="zoom-out-btn">âˆ’</button>
            <button class="zoom-btn" id="zoom-in-btn">+</button>
        </div>
    </div>
</div>
<div id="tab-bar"><div id="tabs-container"></div><div id="tab-indicator"></div><button id="add-tab-btn">+</button></div>
<div id="container-viewport"><div id="container"></div></div>
<div id="version-tag">v3.2</div>

<!-- Auth Modal -->
<div id="auth-modal" class="modal-overlay" onclick="if(event.target==this) window.closeAuthModal()">
    <div class="modal-box">
        <h3 id="auth-title">SYNC WITH CLOUD</h3>
        <input type="text" id="auth-user" placeholder="Username (Min 3 chars)">
        <input type="password" id="auth-pass" placeholder="Password (Min 6 chars)">
        <button class="btn-primary" style="width:100%; padding:14px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-weight:800; text-transform:uppercase; cursor:pointer; transition:0.3s;" onmouseover="this.style.boxShadow='0 0 20px rgba(255,0,0,0.4)'" onmouseout="this.style.boxShadow='none'" onclick="window.handleAuth()">Confirm</button>
        <button class="btn-secondary" style="width:100%; padding:10px; border:none; border-radius:8px; background:transparent; color:#777; cursor:pointer; font-size:11px; margin-top:5px;" id="auth-switch" onclick="window.switchAuthMode()">No account? Create one</button>
        <button class="btn-secondary" style="width:100%; padding:10px; border:none; border-radius:8px; background:transparent; color:#777; cursor:pointer; font-size:11px;" onclick="window.closeAuthModal()">Cancel</button>
    </div>
</div>

<!-- Tab Context Menu -->
<div id="tab-menu">
    <div id="main-menu-group">
        <div class="menu-item" id="menu-rename">Rename Script âœŽ</div>
        <div class="menu-item danger" id="menu-delete">Delete Tab ðŸ—‘</div>
    </div>
    <div id="rename-section" style="display:none; padding:8px;">
        <input type="text" id="inner-rename-input" style="width:100%; margin-bottom:10px; background:#121212; color:#fff; border:1px solid #444; padding:8px; border-radius:6px;">
        <div style="display:flex; gap:5px;"><button id="rename-cancel" style="flex:1; padding:5px; background:#333; color:#fff; border:none; border-radius:4px;">Back</button><button id="rename-apply" style="flex:1; padding:5px; background:var(--accent); color:#fff; border:none; border-radius:4px;">Save</button></div>
    </div>
</div>

<script>
/* ==========================================================
   FIREBASE CORE & CONFIG
   ========================================================== */
const firebaseConfig = {
    apiKey: "AIzaSyCdbYqWYST57jJRR2SBi05hFonp1AlK180",
    authDomain: "webapp-karaca.firebaseapp.com",
    projectId: "webapp-karaca",
    storageBucket: "webapp-karaca.firebasestorage.app",
    messagingSenderId: "244265873424",
    appId: "1:244265873424:web:ad4c9f31b438a8c9c49a95",
    measurementId: "G-9P9SFP89RC"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const appId = typeof __app_id !== 'undefined' ? __app_id : 'roblox-ide-master';
db.enablePersistence({ synchronizeTabs: true }).catch(err => console.log(err.code));

let currentUser = null;
let isRegisterMode = false;
let saveDebounceTimer = null; 

/* UI State Keys */
const TABS_KEY = 'roblox_tabs_master_v32';
const ACTIVE_ID_KEY = 'active_tab_id_v32';
const DEFAULT_CODE = 'print("Hello World")';

/* Initial Load - Always from LocalStorage (Guest Mode) */
let tabs = JSON.parse(localStorage.getItem(TABS_KEY)) || [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE, viewState: null, fontSize: 16 }];
let activeTabId = parseInt(localStorage.getItem(ACTIVE_ID_KEY)) || tabs[0].id;
tabs = tabs.map(t => ({...t, fontSize: t.fontSize || 16}));
let targetTabId = null;

/* --- UI Handlers --- */
window.updateIndicator = () => {
    const el = document.querySelector('.tab.active');
    const ind = document.getElementById('tab-indicator');
    if (el && ind) { 
        ind.style.width = el.offsetWidth + 'px'; 
        ind.style.left = el.offsetLeft + 'px'; 
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
};

window.renderTabs = () => {
    const container = document.getElementById('tabs-container');
    container.innerHTML = '';
    tabs.forEach(tab => {
        const div = document.createElement('div');
        div.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
        div.innerHTML = `<span class="tab-name">${tab.name}</span><div class="tab-options-btn">â‰¡</div>`;
        div.onclick = (e) => { if(!e.target.classList.contains('tab-options-btn')) window.switchTab(tab.id); };
        const optBtn = div.querySelector('.tab-options-btn');
        optBtn.onclick = (e) => { e.stopPropagation(); const rect = optBtn.getBoundingClientRect(); window.showTabMenu(tab.id, rect.left - 150, rect.bottom + 5); };
        container.appendChild(div);
    });
    setTimeout(window.updateIndicator, 100);
};

/* --- SYSTEM SAVE LOGIC (Exclusive Paths) --- */
async function saveCore(isClosing = false) {
    const currentTab = tabs.find(t => t.id === activeTabId);
    if (currentTab && window.editorInstance) {
        currentTab.content = window.editorInstance.getValue();
        currentTab.viewState = window.editorInstance.saveViewState(); 
    }

    if (currentUser) {
        const userRef = db.doc(`artifacts/${appId}/users/${currentUser.uid}/data/state`);
        const payload = { tabs, activeTabId, lastSync: Date.now() };
        try {
            const cleanPayload = JSON.parse(JSON.stringify(payload));
            await userRef.set(cleanPayload, { merge: true });
            if(!isClosing) console.log("Saved to Cloud");
        } catch(e) { console.error("Cloud Save Failed", e); }
    } else {
        localStorage.setItem(TABS_KEY, JSON.stringify(tabs));
        localStorage.setItem(ACTIVE_ID_KEY, activeTabId.toString());
        if(!isClosing) console.log("Saved to Device");
    }
}

function saveState() {
    clearTimeout(saveDebounceTimer);
    saveDebounceTimer = setTimeout(() => saveCore(false), 1000);
}

window.addEventListener('beforeunload', () => saveCore(true));
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') saveCore(true);
});

/* --- INTELLIGENT AUTO-UPDATE SYSTEM (v3.2 Logic) --- */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => {
            reg.update();
            setInterval(() => reg.update(), 5 * 60 * 1000); // Check every 5 mins
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') reg.update();
            });
        });
    });

    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', async () => {
        if (!refreshing) {
            refreshing = true;
            console.log("New version detected! Saving and reloading...");
            
            const toast = document.createElement('div');
            toast.style.cssText = "position:fixed; bottom:20px; right:20px; background:linear-gradient(45deg, #00ce09, #00ff88); color:black; padding:15px 30px; border-radius:50px; z-index:100000; font-weight:900; box-shadow:0 10px 30px rgba(0,255,0,0.3); font-size:14px; animation: slideUpToast 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display:flex; align-items:center; gap:10px;";
            toast.innerHTML = "<span>ðŸš€</span> UPDATING ZENU HUB...";
            document.body.appendChild(toast);

            await saveCore(true);
            setTimeout(() => window.location.reload(), 2000);
        }
    });
}

/* --- Auth & Data Loading Logic --- */
window.handleAccountAction = () => {
    if (currentUser) {
        if (confirm(`User: ${currentUser.username}\nLogout and Switch to Local Storage?`)) {
            saveCore(true);
            auth.signOut().then(() => {
                const localTabs = JSON.parse(localStorage.getItem(TABS_KEY));
                const localId = parseInt(localStorage.getItem(ACTIVE_ID_KEY));
                if (localTabs) {
                    tabs = localTabs.map(t => ({...t, fontSize: t.fontSize || 16}));
                    activeTabId = localId || tabs[0].id;
                } else {
                    tabs = [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE, fontSize: 16 }];
                    activeTabId = tabs[0].id;
                }
                window.refreshEditorState();
                window.renderTabs();
            });
        }
        return;
    }
    document.getElementById('auth-modal').style.display = 'flex';
};

window.closeAuthModal = () => document.getElementById('auth-modal').style.display = 'none';
window.switchAuthMode = () => {
    isRegisterMode = !isRegisterMode;
    document.getElementById('auth-title').innerText = isRegisterMode ? "CREATE CLOUD ACCOUNT" : "SYNC WITH CLOUD";
    document.getElementById('auth-switch').innerText = isRegisterMode ? "Back to Login" : "No account? Create one";
};

window.handleAuth = async () => {
    const userPart = document.getElementById('auth-user').value.trim();
    const pass = document.getElementById('auth-pass').value;
    if (userPart.length < 3 || pass.length < 6) return alert("Username must be 3+ chars, Password 6+");
    const email = `${userPart.toLowerCase()}@master.ide`;
    const usernameId = userPart.toLowerCase();

    try {
        if (isRegisterMode) {
            const usernameDoc = await db.doc(`artifacts/${appId}/usernames/${usernameId}`).get();
            if (usernameDoc.exists) return alert("Username taken.");
            const res = await auth.createUserWithEmailAndPassword(email, pass);
            const batch = db.batch();
            const cleanTabs = JSON.parse(JSON.stringify(tabs));
            batch.set(db.doc(`artifacts/${appId}/users/${res.user.uid}/data/state`), { tabs: cleanTabs, activeTabId, lastSync: Date.now(), username: userPart });
            batch.set(db.doc(`artifacts/${appId}/usernames/${usernameId}`), { uid: res.user.uid });
            await batch.commit();
        } else {
            await auth.signInWithEmailAndPassword(email, pass);
        }
        window.closeAuthModal();
    } catch (e) { alert(e.message); }
};

auth.onAuthStateChanged(async (user) => {
    const btn = document.getElementById('auth-btn');
    if (user) {
        currentUser = { uid: user.uid, username: user.email.split('@')[0] };
        btn.innerHTML = `<span>ðŸ‘¤</span> ${currentUser.username.toUpperCase()}`;
        try {
            const doc = await db.doc(`artifacts/${appId}/users/${user.uid}/data/state`).get();
            if (doc.exists) {
                const data = doc.data();
                if (data.tabs) tabs = data.tabs.map(t => ({...t, fontSize: t.fontSize || 16}));
                activeTabId = data.activeTabId || activeTabId;
                window.refreshEditorState();
                window.renderTabs();
            }
        } catch(e) { console.error("Fetch Error", e); }
    } else { 
        currentUser = null; 
        btn.innerHTML = `<span>ðŸ‘¤</span> LOGIN`; 
    }
});

window.refreshEditorState = () => {
    if (!window.editorInstance) return;
    const currentTab = tabs.find(t => t.id === activeTabId);
    if (currentTab) {
        window.editorInstance.updateOptions({ fontSize: currentTab.fontSize || 16 });
        window.editorInstance.setValue(currentTab.content);
        if (currentTab.viewState) {
            window.editorInstance.restoreViewState(currentTab.viewState);
        } else {
            window.editorInstance.setScrollTop(0);
        }
        window.editorInstance.focus();
    }
};

const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
window.addEventListener('DOMContentLoaded', () => {
    window.renderTabs();
    if (isStandalone) document.getElementById('install-app-btn')?.remove();
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
<script>
/* Monaco Engine */
const workerBlob = new Blob([`
    self.MonacoEnvironment = { baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/' };
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/base/worker/workerMain.js');
`], { type: 'application/javascript' });
window.MonacoEnvironment = { getWorkerUrl: () => URL.createObjectURL(workerBlob) };

require.config({ paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'} });

require(['vs/editor/editor.main'],()=>{

/* ==========================================================
   ULTIMATE ROBLOX API & DATA TYPES (EXPANDED MASTER)
   ========================================================== */
const COMMON = ['Destroy','Clone','FindFirstChild','WaitForChild','GetChildren','GetDescendants','IsA','Connect','Wait','Once','Disconnect','GetPropertyChangedSignal','SetAttribute','GetAttribute','IsDescendantOf','GetFullName','FindFirstAncestor','FindFirstAncestorOfClass','FindFirstChildOfClass','ClearAllChildren','GetActor','GetAttributes','RemoveAttribute'];

const API = {
  game: {
    props: ['Workspace','Players','Lighting','ReplicatedStorage','ServerStorage','ServerScriptService','StarterGui','StarterPack','RunService','TweenService','UserInputService','HttpService','DataStoreService','Debris','Teams','PathfindingService','CollectionService','MarketplaceService','TeleportService','Chat','SoundService','LogService','BadgeService','AssetService','AnalyticsService','SocialService','Selection','TestService','VRService','PolicyService','ProximityPromptService','ContextActionService','ContentProvider','PhysicsService','ScriptContext','Stats','TextService','GroupService','MemStorageService','GuiService','StarterPlayer','LocalizationService','VoiceChatService'],
    methods: ['GetService','BindToClose','IsLoaded','Shutdown','IsAncestorOf','IsDescendantOf','GetObjects','FindService','GetJobsExtended','IsNetworkSettled','SetPlaceId','SetUniverseId','DefineFastFlag','GetFastFlag']
  },
  Workspace: {
    props: ['CurrentCamera','Terrain','Gravity','GlobalWind','FallenPartsDestroyHeight','StreamingEnabled','DistributedGameTime','AllowAudioIsolation','InterpolationThrottling','SignalBehavior','MeshPartHeadsAndAccessories','AnimationWeightedBlendFix'],
    methods: ['Raycast','GetPartBoundsInBox','GetPartsInPart','GetPartBoundsInRadius','FindPartOnRay','FindPartOnRayWithIgnoreList','BulkMoveTo','GetRealtimeVelocityAtPoint','FindPartOnRayWithWhitelist','Spherecast','Blockcast','Shapecast','JoinToOutsiders','UnjoinFromOutsiders','ZoomToExtents']
  },
  Players: {
    props: ['LocalPlayer','MaxPlayers','RespawnTime','PlayerAdded','PlayerRemoving','CharacterAutoLoads','BubbleChat','PreferredPlayersCount'],
    methods: ['GetPlayers','GetPlayerFromCharacter','GetNameFromUserIdAsync','GetUserIdFromNameAsync','GetUserThumbnailAsync','CreateHumanoidModelFromUserId','BanAsync','UnbanAsync','GetFriendsAsync','GetUserFriendsAsync','IsFriendsWith','GetPlayerByUserId']
  },
  Player: {
    props: ['Name','UserId','Character','Backpack','PlayerGui','Team','DisplayName','AccountAge','LocaleId','MembershipType','FollowUserId','RespawnLocation','CharacterAdded','CharacterRemoving','SimulationRadius','DataReady','DevComputerCameraMode','DevTouchCameraMode','CameraMaxZoomDistance','CameraMinZoomDistance','ReplicationFocus','Idled'],
    methods: ['Kick','LoadCharacter','GetMouse','IsInGroup','GetRankInGroup','GetRoleInGroup','ClearCharacterAppearance','HasAppearanceLoaded','Move','SetCanSelfTerminate','GetJoinData','GetNetworkSimulator','RequestStreamAroundAsync','DistanceFromCharacter']
  },
  Lighting: {
    props: ['Ambient','Brightness','ColorShift_Bottom','ColorShift_Top','GlobalShadows','OutdoorAmbient','Outlines','ShadowShadowSoftness','ClockTime','GeographicLatitude','ExposureCompensation','FogColor','FogEnd','FogStart','EnvironmentDiffuseScale','EnvironmentSpecularScale','Technology','TimeOfDay'],
    methods: ['SetMinutesAfterMidnight','GetMinutesAfterMidnight','GetMoonDirection','GetSunDirection']
  },
  ReplicatedStorage: { props: [], methods: [] },
  ServerStorage: { props: [], methods: [] },
  ServerScriptService: { props: [], methods: [] },
  StarterGui: { props: ['ScreenGui','ResetPlayerGuiOnSpawn'], methods: ['SetCore','GetCore','SetCoreGuiEnabled','GetCoreGuiEnabled'] },
  StarterPack: { props: [], methods: [] },
  Instance: {
    props: ['Name','Parent','ClassName','Archivable'],
    methods: ['new','Destroy','Clone','FindFirstChild','WaitForChild','GetChildren','GetDescendants','IsA','GetPropertyChangedSignal','SetAttribute','GetAttribute','ClearAllChildren','IsDescendantOf','GetFullName','RemoveAttribute','GetAttributes','FindFirstAncestor','FindFirstAncestorOfClass','FindFirstAncestorWhichIsA','FindFirstChildOfClass','FindFirstChildWhichIsA','GetActor','DebugId']
  },
  Part: {
    props: ['Anchored','CanCollide','CanTouch','CanQuery','Transparency','Reflectance','Color','Material','Position','Size','CFrame','Velocity','AssemblyLinearVelocity','AssemblyAngularVelocity','Mass','Orientation','Shape','Locked','CastShadow','CollisionGroup','PivotOffset','Touched','TouchEnded','Changed','LocalTransparencyModifier','CenterOfMass','ReceiveAge','AssemblyCenterOfMass','AssemblyMass','CustomPhysicalProperties','RootPriority','RotVelocity'],
    methods: ['ApplyImpulse','GetMass','SetNetworkOwner','GetNetworkOwner','BreakJoints','GetRootPart','GetConnectedParts','ApplyAngularImpulse','Resize','TranslateBy','Subtract','Union','Intersect','ApplyImpulseAtPosition','GetClosestPointOnSurface','GetTouchingParts','CanSetNetworkOwnership']
  },
  Model: {
    props: ['PrimaryPart','WorldPivot'],
    methods: ['BreakJoints','MakeJoints','MoveTo','SetPrimaryPartCFrame','GetPrimaryPartCFrame','TranslateBy','GetBoundingBox','GetExtentsSize','ScaleTo','PivotTo']
  },
  Humanoid: {
    props: ['Health','MaxHealth','WalkSpeed','JumpPower','JumpHeight','HipHeight','Sit','MoveDirection','PlatformStand','AutoRotate','UseJumpPower','DisplayName','HealthDisplayType','Died','StateChanged','ClimbSpeed','FloorMaterial','BreakJointsOnDeath','DisplayDistanceType','RigType','RootPart','SeatPart','TargetPoint','WalkToPart','WalkToPoint'],
    methods: ['TakeDamage','Move','MoveTo','EquipTool','UnequipTools','ChangeState','GetState','LoadAnimation','AddCustomStatus','ApplyDescription','GetAccessories','GetBodyPartR6','GetBodyPartR15','GetPlayingAnimationTracks','SetStateEnabled','GetStateEnabled','BuildRigFromAttachments']
  },
  Camera: {
    props: ['CFrame','Focus','FieldOfView','CameraType','ViewportSize','NearPlaneZ','HeadLocked','HeadScale','CameraSubject','DiagonalFieldOfView','MaxAxisFieldOfView'],
    methods: ['WorldToViewportPoint','WorldToScreenPoint','ViewportPointToRay','ScreenPointToRay','GetLargestCutoffDistance','GetRenderCFrame','Interpolate']
  },
  GuiObject: { props: ['Active','AnchorPoint','BackgroundColor3','BackgroundTransparency','BorderColor3','BorderSizePixel','ClipsDescendants','Draggable','LayoutOrder','Position','Rotation','Size','Visible','ZIndex','MouseEnter','MouseLeave','InputBegan','InputEnded'], methods: ['TweenPosition','TweenSize','TweenSizeAndPosition'] },
  ScreenGui: { props: ['DisplayOrder','Enabled','IgnoreGuiInset','ResetOnSpawn','ZIndexBehavior'], methods: [] },
  Frame: { props: ['Style'], methods: [] },
  TextLabel: { props: ['Font','Text','TextColor3','TextSize','TextStrokeColor3','TextStrokeTransparency','TextTransparency','TextWrapped','TextXAlignment','TextYAlignment','TextScaled','RichText','MaxVisibleGraphemes','LineHeight'], methods: [] },
  TextButton: { props: ['Font','Text','TextColor3','TextSize','TextStrokeColor3','TextStrokeTransparency','TextTransparency','TextWrapped','TextXAlignment','TextYAlignment','TextScaled','RichText','MouseButton1Click','MouseButton2Click','MouseButton1Down','MouseButton1Up'], methods: [] },
  TextBox: { props: ['ClearTextOnFocus','CursorPosition','Font','MultiLine','PlaceholderText','SelectionStart','Text','TextColor3','TextSize','TextWrapped','TextXAlignment','TextYAlignment','FocusLost','Focused'], methods: ['CaptureFocus','ReleaseFocus'] },
  ImageLabel: { props: ['Image','ImageColor3','ImageRectOffset','ImageRectSize','ImageTransparency','ScaleType','SliceCenter','TileSize'], methods: [] },
  ImageButton: { props: ['Image','ImageColor3','ImageRectOffset','ImageRectSize','ImageTransparency','ScaleType','SliceCenter','TileSize','MouseButton1Click','MouseButton1Down','MouseButton1Up'], methods: [] },
  ScrollingFrame: { props: ['CanvasPosition','CanvasSize','ElasticBehavior','HorizontalScrollBarInset','ScrollBarImageColor3','ScrollBarImageTransparency','ScrollBarThickness','ScrollingDirection','VerticalScrollBarInset','VerticalScrollBarPosition'], methods: [] },
  Animation: { props: ['AnimationId'], methods: [] },
  AnimationTrack: { props: ['IsPlaying','Length','Looped','Priority','Speed','TimePosition','WeightTarget','KeyframeReached','Stopped'], methods: ['Play','Stop','AdjustSpeed','AdjustWeight','GetTimeOfKeyframe'] },
  Sound: { props: ['SoundId','Playing','Looped','Volume','PlaybackSpeed','TimePosition','RollOffMaxDistance','RollOffMinDistance','RollOffMode','IsLoaded','IsPaused','TimeLength','Ended','DidLoop'], methods: ['Play','Stop','Pause','Resume'] },
  TweenService: { props: [], methods: ['Create','GetValue'] },
  RunService: { props: ['Heartbeat','RenderStepped','Stepped'], methods: ['IsClient','IsServer','IsStudio','IsRunning','BindToRenderStep','UnbindFromRenderStep','IsEdit','IsRunMode'] },
  HttpService: { props: ['HttpEnabled'], methods: ['GetAsync','PostAsync','JSONEncode','JSONDecode','GenerateGUID','UrlEncode','RequestAsync'] },
  DataStoreService: { props: ['AutomaticRetry'], methods: ['GetDataStore','GetOrderedDataStore','GetGlobalDataStore','ListDataStoresAsync'] },
  CollectionService: { props: [], methods: ['AddTag','RemoveTag','HasTag','GetTags','GetTagged','GetInstanceAddedSignal','GetInstanceRemovedSignal'] },
  PathfindingService: { methods: ['CreatePath','FindPathAsync','GetPath'] },
  UserInputService: {
    props: ['KeyboardEnabled','MouseEnabled','TouchEnabled','GamepadEnabled','AccelerometerEnabled','GyroscopeEnabled','InputBegan','InputEnded','InputChanged','JumpRequest','TouchStarted','TouchEnded','TouchMoved','TouchTap','TouchPinch','TouchLongPress','TouchPan','TouchRotate','TouchSwipe','WindowFocused','WindowFocusReleased'],
    methods: ['GetKeysPressed','IsKeyDown','IsMouseButtonPressed','GetFocusedTextBox','GetMouseLocation','GetConnectedGamepads','IsGamepadButtonDown','GetGamepadState','GetDeviceRotation','GetDeviceGravity','GetDeviceAcceleration']
  },
  ContextActionService: { methods: ['BindAction','UnbindAction','BindActionAtPriority','UnbindAllActions','SetTitle','SetImage','SetPosition','GetButton','SetDescription'] },
  TeleportService: { methods: ['Teleport','TeleportToPlaceInstance','TeleportToPrivateServer','TeleportPartyAsync','ReserveServer','GetLocalPlayerTeleportData','SetTeleportGui'] },
  GuiService: { props: ['MenuIsOpen','SelectedObject'], methods: ['GetGuiInset'] },
  MarketplaceService: { methods: ['GetProductInfo','PromptGamePassPurchase','PromptPurchase','UserOwnsGamePassAsync','ProcessReceipt','PromptBundlePurchase','PromptPremiumPurchase','GetDeveloperProductsAsync'] },
  SoundService: { props: ['AmbientReverb','DistanceFactor','RolloffScale','RespectFilteringEnabled'], methods: ['GetListener','PlayLocalSound'] },
  RemoteEvent: { props: ['OnServerEvent','OnClientEvent'], methods: ['FireServer','FireClient','FireAllClients'] },
  RemoteFunction: { props: ['OnServerInvoke','OnClientInvoke'], methods: ['InvokeServer','InvokeClient'] },
  Debris: { methods: ['AddItem'] },
  LogService: { methods: ['GetLogHistory','RequestServerLog','MessageOut'] },
  BadgeService: { methods: ['GetBadgeInfoAsync','AwardBadge','UserHasBadgeAsync'] },
  ProximityPrompt: { props: ['ActionText','ObjectText','HoldDuration','KeyboardKeyCode','MaxActivationDistance','RequiresLineOfSight','Style','Triggered','PromptButtonHoldBegan','PromptButtonHoldEnded'], methods: ['InputHoldBegin','InputHoldEnd'] },
  Teams: { methods: ['GetTeams'] },
  Team: { props: ['TeamColor','AutoAssignable'] },
  StarterPlayer: { props: ['NameDisplayDistance','HealthDisplayDistance','CharacterUseJumpPower'] }
};

const DATA_TYPES = {
  Vector3: { props: ['X','Y','Z','Magnitude','Unit'], methods: ['Dot','Cross','Lerp','FuzzyEq','Abs','Ceil','Floor','Sign','Max','Min'], static: ['new','zero','one','xAxis','yAxis','zAxis'] },
  Vector2: { props: ['X','Y','Magnitude','Unit'], methods: ['Dot','Cross','Lerp','Min','Max'], static: ['new','zero','one'] },
  CFrame: { props: ['Position','LookVector','RightVector','UpVector','X','Y','Z','p','Rotation'], methods: ['Lerp','Inverse','ToObjectSpace','ToWorldSpace','ToEulerAnglesXYZ','ToOrientation','ToAxisAngle','GetComponents','Inverse','Orthonormalize','PointToWorldSpace','PointToObjectSpace','VectorToWorldSpace','VectorToObjectSpace'], static: ['new','Angles','lookAt','fromAxisAngle','fromMatrix','fromOrientation','fromEulerAnglesXYZ'] },
  Color3: { props: ['R','G','B'], methods: ['ToHSV','Lerp','ToHex'], static: ['new','fromRGB','fromHSV','fromHex'] },
  BrickColor: { props: ['Name','Number','Color','r','g','b'], static: ['new','Random','White','Black','Red','Blue','Green','Yellow','DarkGray','Gray','palette'] },
  UDim2: { props: ['X','Y','Width','Height'], methods: ['Lerp'], static: ['new','fromScale','fromOffset'] },
  UDim: { props: ['Scale','Offset'], static: ['new'] },
  Ray: { props: ['Origin','Direction','Unit'], methods: ['ClosestPoint','Distance'], static: ['new'] },
  Region3: { props: ['CFrame','Size'], methods: ['ExpandToGrid'], static: ['new'] },
  Rect: { props: ['Min','Max','Width','Height'], static: ['new'] },
  ColorSequence: { props: ['Keypoints'], static: ['new'] },
  ColorSequenceKeypoint: { props: ['Time','Value'], static: ['new'] },
  NumberSequence: { props: ['Keypoints'], static: ['new'] },
  NumberSequenceKeypoint: { props: ['Time','Value','Envelope'], static: ['new'] },
  NumberRange: { props: ['Min','Max'], static: ['new'] },
  DateTime: { props: ['UnixTimestamp','UnixTimestampMillis'], methods: ['FormatLocalTime','FormatUniversalTime','ToUniversalTime','ToISO8601'], static: ['now','fromUnixTimestamp','fromISO8601','fromLocalTime','fromUniversalTime'] },
  PhysicalProperties: { props: ['Density','Friction','Elasticity','FrictionWeight','ElasticityWeight'], static: ['new'] },
  Font: { props: ['Family','Weight','Style','Bold'], static: ['new','fromId','fromName','fromEnum'] },
  Axes: { props: ['X','Y','Z','Top','Bottom','Left','Right','Back','Front'], static: ['new'] },
  Faces: { props: ['Top','Bottom','Left','Right','Back','Front'], static: ['new'] },
  RaycastParams: { props: ['FilterDescendantsInstances','FilterType','IgnoreWater','CollisionGroup','RespectCanCollide','BruteForceAllSlow'], static: ['new'] },
  RaycastResult: { props: ['Instance','Position','Normal','Material','Distance'] },
  OverlapParams: { props: ['FilterDescendantsInstances','FilterType','MaxParts','CollisionGroup','RespectCanCollide'], static: ['new'] },
  TweenInfo: { props: ['Time','EasingStyle','EasingDirection','RepeatCount','Reverses','DelayTime'], static: ['new'] },
  DockWidgetPluginGuiInfo: { static: ['new'] },
  PathWaypoint: { props: ['Action','Position','Label'], static: ['new'] },
  Random: { methods: ['NextInteger','NextNumber','Clone'], static: ['new'] },
  Enum: { props: ['KeyCode','RenderPriority','Material','SortOrder','Font','TextXAlignment','TextYAlignment','UserInputType','UserInputState','ContextActionPriority','EasingStyle','EasingDirection','CameraType','HttpContentType','ThreadPoolConfig','QualityLevel','RaycastFilterType','PathWaypointAction'] }
};

const LUA_LIBS = {
  table: { methods: ['insert','remove','sort','concat','find','create','clear','unpack','pack','move','freeze','isfrozen','getn','foreach','foreachi','clone','maxn'] },
  math: { methods: ['abs','acos','asin','atan','atan2','ceil','cos','cosh','deg','exp','floor','fmod','frexp','ldexp','log','log10','max','min','modf','pow','rad','random','randomseed','sin','sinh','sqrt','tan','tanh','clamp','huge','pi','noise','round','sign'] },
  string: { methods: ['byte','char','find','format','gmatch','gsub','len','lower','match','rep','reverse','sub','upper','split','pack','unpack','packsize'] },
  task: { methods: ['wait','spawn','defer','delay','cancel','desynchronize','synchronize'] },
  os: { methods: ['time','date','difftime','clock'] },
  utf8: { methods: ['char','charpos','codes','codepoint','len','offset','graphemes','nfcnormalize','nfdnormalize'] },
  coroutine: { methods: ['create','resume','running','status','wrap','yield','close','isyieldable'] },
  debug: { methods: ['traceback','profilebegin','profileend','getmemorycategory','setmemorycategory','info','dump','load','getupvalue','setupvalue','getconstant','getproto','setstack','setconstant','getconstants','getprotos','getregistry','setmetatable','getmetatable'] },
  bit32: { methods: ['arshift','band','bnot','bor','btest','bxor','countlz','countrz','extract','lrotate','lshift','replace','rrotate','rshift'] },
  buffer: { methods: ['create','fromstring','tostring','copy','fill','readi8','readu8','readi16','readu16','readi32','readu32','readf32','readf64','writei8','writeu8','writei16','writeu16','writei32','writeu32','writef32','writef64','len'] },
  vector: { methods: ['create','magnitude','normalize','cross','dot','angle','min','max','ceil','floor','sign','abs'] },
  SharedTable: { methods: ['new','clear','clone','increment','update'] },
  crypt: { methods: ['base64encode','base64decode','encrypt','decrypt','generatebytes','generatekey','hash'] },
  Drawing: { methods: ['new','Fonts','clear'] },
  WebSocket: { methods: ['connect'] },
  rconsole: { methods: ['print','info','warn','err','clear','name','input'] },
  cache: { methods: ['invalidate','replace','iscached'] },
  lz4: { methods: ['compress','decompress'] }
};

const GLOBAL_FUNCS = ['print','warn','error','wait','spawn','delay','tick','time','typeof','type','pairs','ipairs','pcall','xpcall','assert','require','tostring','tonumber','task','shared','_G','getfenv','setfenv','next','rawget','rawset','rawequal','select','gcinfo','collectgarbage','newproxy','ypcall','getgenv','getrenv','getsenv','getreg','getgc','getinstances','getnilinstances','getloadedmodules','getconnections','firesignal','fireclickdetector','fireproximityprompt','firetouchinterest','isnetworkowner','gethiddenproperty','sethiddenproperty','setsimulationradius','settings','UserSettings','elapsedTime','version','printidentity','gethui','getrunningscripts','readfile','writefile','appendfile','loadfile','listfiles','isfile','isfolder','makefolder','delfolder','delfile','setclipboard','setfpscap','mouse1click','mouse1press','mouse1release','mouse2click','mouse2press','mouse2release','keypress','keyrelease','loadstring','identifyexecutor','getexecutorname','queue_on_teleport','request','http_request','clonefunction','checkcaller','hookfunction','hookmetamethod','newcclosure','replaceclosure','setreadonly','isreadonly','make_writeable','make_readonly','is_writeable','getproperties'];

const SNIPPETS = [
  {label:'if',insertText:'if ${1:condition} then\n\t$0\nend'},
  {label:'elseif',insertText:'elseif ${1:condition} then\n\t$0'},
  {label:'do',insertText:'do\n\t$0\nend'},
  {label:'while',insertText:'while ${1:condition} do\n\t$0\nend'},
  {label:'repeat',insertText:'repeat\n\t$0\nuntil ${1:condition}'},
  {label:'fori',insertText:'for ${1:i} = ${2:1}, ${3:10} do\n\t$0\nend'},
  {label:'forp',insertText:'for ${1:i}, ${2:v} in pairs(${3:table}) do\n\t$0\nend'},
  {label:'function',insertText:'function ${1:name}(${2:params})\n\t$0\nend'},
  {label:'lfunction',insertText:'local function ${1:name}(${2:params})\n\t$0\nend'},
  {label:'remote',insertText:'game:GetService("ReplicatedStorage"):WaitForChild("${1:RemoteName}").OnServerEvent:Connect(function(player, $2)\n\t$0\nend)'},
  {label:'datastore',insertText:'local DataStoreService = game:GetService("DataStoreService")\nlocal myDataStore = DataStoreService:GetDataStore("${1:DataName}")\n\nlocal success, errorMessage = pcall(function()\n\t$0\nend)'},
  {label:'raycast',insertText:'local params = RaycastParams.new()\nparams.FilterType = Enum.RaycastFilterType.Exclude\nlocal result = workspace:Raycast(${1:origin}, ${2:direction}, params)\nif result then\n\t$0\nend'},
  {label:'tween',insertText:'local TweenService = game:GetService("TweenService")\nlocal info = TweenInfo.new(${1:1}, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)\nlocal tween = TweenService:Create(${2:object}, info, {${3:Property} = ${4:Value}})\ntween:Play()'},
  {label:'pcall',insertText:'local success, result = pcall(function()\n\t$0\nend)'},
  {label:'module',insertText:'local module = {}\n\nfunction module.${1:funcName}()\n\t$0\nend\n\nreturn module'},
  {label:'bindaction',insertText:'local ContextActionService = game:GetService("ContextActionService")\n\nlocal function handleAction(actionName, inputState, inputObject)\n\tif inputState == Enum.UserInputState.Begin then\n\t\t$0\n\tend\nend\n\nContextActionService:BindAction("${1:ActionName}", handleAction, true, Enum.KeyCode.${2:E})'},
  {label:'taskspawn',insertText:'task.spawn(function()\n\t$0\nend)'},
  {label:'connection',insertText:'local connection\nconnection = ${1:Signal}:Connect(function()\n\t$0\n\tconnection:Disconnect()\nend)'},
  {label:'service',insertText:'local ${1:Service} = game:GetService("${1:Service}")'}
];

const LUA_KEYWORDS=['local','function','if','then','elseif','else','for','while','repeat','until','do','end','return','break','continue','and','or','not','true','false','nil','in','export','type'];

const KNOWN_WORDS = new Set([ ...LUA_KEYWORDS, ...GLOBAL_FUNCS, ...Object.keys(API), ...Object.keys(DATA_TYPES), ...Object.keys(LUA_LIBS) ]);

// Initialize with font size from the active tab
const startTab = tabs.find(t => t.id === activeTabId) || tabs[0];
window.editorInstance = monaco.editor.create(document.getElementById('container'), {
    value: startTab.content,
    language: 'lua', theme: 'vs-dark', 
    fontSize: startTab.fontSize || 16, // Use per-tab font size
    automaticLayout: true,
    minimap: { enabled: true }, cursorSmoothCaretAnimation: true, smoothScrolling: true,
    wordWrap: "off", scrollbar: { vertical: 'visible', horizontal: 'visible', verticalScrollbarSize: 10, horizontalScrollbarSize: 10 },
    fixedOverflowWidgets: true, quickSuggestions: true, suggestOnTriggerCharacters: true,
    tabCompletion: "on", snippetSuggestions: "top",
    wordBasedSuggestions: false // Disable default to use our smart custom provider
});

// Restore Initial State if available
if(startTab && startTab.viewState) { window.editorInstance.restoreViewState(startTab.viewState); }

// Zoom Buttons - Update PER TAB
document.getElementById('zoom-in-btn').onclick = () => { 
    const cur = tabs.find(t => t.id === activeTabId);
    if(cur) {
        cur.fontSize = (cur.fontSize || 16) + 2;
        window.editorInstance.updateOptions({fontSize: cur.fontSize}); 
        saveCore(); 
    }
};
document.getElementById('zoom-out-btn').onclick = () => { 
    const cur = tabs.find(t => t.id === activeTabId);
    if(cur) {
        cur.fontSize = Math.max(6, (cur.fontSize || 16) - 2); // Prevent too small
        window.editorInstance.updateOptions({fontSize: cur.fontSize}); 
        saveCore(); 
    }
};

/* Smart Tab Switching with State Capture */
window.switchTab = (id) => {
    if (id === activeTabId) return;
    const oldIndex = tabs.findIndex(t => t.id === activeTabId);
    const newIndex = tabs.findIndex(t => t.id === id);
    
    // Save Old State
    if(tabs[oldIndex]) {
        tabs[oldIndex].content = window.editorInstance.getValue();
        tabs[oldIndex].viewState = window.editorInstance.saveViewState();
        // fontSize is already up to date in tabs array
    }
    
    const container = document.getElementById('container');
    const direction = newIndex > oldIndex ? 'next' : 'prev';
    container.className = direction === 'next' ? 'anim-next-out' : 'anim-prev-out';
    
    setTimeout(() => {
        activeTabId = id; 
        const newTab = tabs[newIndex];
        
        window.editorInstance.setValue(newTab.content);
        // Apply Tab's Font Size
        window.editorInstance.updateOptions({ fontSize: newTab.fontSize || 16 });
        
        if (newTab.viewState) {
            window.editorInstance.restoreViewState(newTab.viewState);
        } else {
            window.editorInstance.setScrollTop(0);
        }

        container.className = direction === 'next' ? 'anim-next-in' : 'anim-prev-in';
        saveState(); window.renderTabs();
        setTimeout(() => { container.className = ''; }, 200);
    }, 150);
};

document.getElementById('add-tab-btn').onclick = () => {
    const cur = tabs.find(t => t.id === activeTabId);
    if(cur) {
        cur.content = window.editorInstance.getValue();
        cur.viewState = window.editorInstance.saveViewState();
    }
    const newId = Date.now();
    // New tab gets default fontSize 16
    tabs.push({ id: newId, name: `Script ${tabs.length + 1}`, content: DEFAULT_CODE, viewState: null, fontSize: 16 });
    window.switchTab(newId);
};

window.editorInstance.onDidChangeModelContent(() => {
    const current = tabs.find(t => t.id === activeTabId);
    if (current) { current.content = window.editorInstance.getValue(); saveState(); }
});

/* Context Menu & Actions */
const menu = document.getElementById('tab-menu');
window.showTabMenu = (id, x, y) => {
    targetTabId = id;
    document.getElementById('main-menu-group').style.display = 'block';
    document.getElementById('rename-section').style.display = 'none';
    menu.style.display = 'block';
    if (x + 180 > window.innerWidth) x -= 180;
    menu.style.left = x + 'px'; menu.style.top = y + 'px';
};
document.addEventListener('mousedown', (e) => { if (!menu.contains(e.target)) menu.style.display = 'none'; });

document.getElementById('menu-rename').onclick = () => {
    document.getElementById('main-menu-group').style.display = 'none';
    document.getElementById('rename-section').style.display = 'block';
    const tab = tabs.find(t => t.id === targetTabId);
    document.getElementById('inner-rename-input').value = tab.name;
    document.getElementById('inner-rename-input').focus();
};
document.getElementById('rename-cancel').onclick = (e) => { e.stopPropagation(); document.getElementById('main-menu-group').style.display = 'block'; document.getElementById('rename-section').style.display = 'none'; };
document.getElementById('rename-apply').onclick = (e) => {
    e.stopPropagation(); const name = document.getElementById('inner-rename-input').value.trim();
    if (name) { tabs.find(t => t.id === targetTabId).name = name; saveState(); window.renderTabs(); }
    menu.style.display = 'none';
};
document.getElementById('menu-delete').onclick = () => {
    menu.style.display = 'none'; tabs = tabs.filter(t => t.id !== targetTabId);
    if (tabs.length === 0) tabs = [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE, fontSize: 16 }];
    if (activeTabId === targetTabId) { activeTabId = tabs[0].id; window.editorInstance.setValue(tabs[0].content); }
    saveState(); window.renderTabs();
};

/* Completion Provider (SMART CONTEXT SCANNER) */
monaco.languages.registerCompletionItemProvider('lua', {
  triggerCharacters: ['.', ':', '"', "'"],
  provideCompletionItems(model, pos) {
    const word = model.getWordUntilPosition(pos);
    const range = { startLineNumber: pos.lineNumber, endLineNumber: pos.lineNumber, startColumn: word.startColumn, endColumn: word.endColumn };
    const line = model.getLineContent(pos.lineNumber);
    const before = line.slice(0, pos.column);
    const m = before.match(/([\w\.:"'\(\)]+)([\.:])$/);
    if (m) {
      const type = m[1]; const colon = m[2] === ':';
      if (API[type]) {
        const out = []; 
        if (!colon) API[type].props.forEach(p => out.push({ label: p, kind: monaco.languages.CompletionItemKind.Property, insertText: p, range }));
        API[type].methods.concat(COMMON).forEach(fn => out.push({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        return { suggestions: out };
      }
      if (DATA_TYPES[type]) {
        const d = DATA_TYPES[type]; const out = [];
        if (!colon) { d.props?.forEach(p => out.push({ label: p, kind: monaco.languages.CompletionItemKind.Property, insertText: p, range })); d.static?.forEach(s => out.push({ label: s, kind: monaco.languages.CompletionItemKind.Method, insertText: s + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range })); }
        d.methods?.forEach(fn => out.push({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        return { suggestions: out };
      }
      if (LUA_LIBS[type] && !colon) return { suggestions: LUA_LIBS[type].methods.map(fn => ({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range })) };
    }
    const suggestions = [];
    LUA_KEYWORDS.forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Keyword, insertText: k, range }));
    GLOBAL_FUNCS.forEach(f => suggestions.push({ label: f, kind: monaco.languages.CompletionItemKind.Function, insertText: f + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
    SNIPPETS.forEach(s => suggestions.push({ label: s.label, kind: monaco.languages.CompletionItemKind.Snippet, insertText: s.insertText, insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
    Object.keys(API).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Class, insertText: k, range }));
    Object.keys(DATA_TYPES).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Struct, insertText: k, range }));
    Object.keys(LUA_LIBS).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Module, insertText: k, range }));
    
    // --- SMART CONTEXT SCANNER ---
    const text = model.getValue();
    if (text.length < 50000) { // Limit scanning for performance
        const foundWords = new Set(KNOWN_WORDS);
        let match;

        // 1. Scan Locals (local x)
        const localRegex = /\blocal\s+([a-zA-Z_]\w*)/g;
        while ((match = localRegex.exec(text)) !== null) {
            const w = match[1];
            if (!foundWords.has(w)) {
                suggestions.push({ label: w, kind: monaco.languages.CompletionItemKind.Variable, detail: '(Local Variable)', insertText: w, range });
                foundWords.add(w);
            }
        }

        // 2. Scan User Functions (function x)
        const funcRegex = /\bfunction\s+([a-zA-Z_]\w*)/g;
        while ((match = funcRegex.exec(text)) !== null) {
            const w = match[1];
            if (!foundWords.has(w)) {
                suggestions.push({ label: w, kind: monaco.languages.CompletionItemKind.Function, detail: '(User Function)', insertText: w, range });
                foundWords.add(w);
            }
        }

        // 3. Scan Globals/Assignments (x = ...)
        const globalRegex = /(?:^|[\r\n\s])([a-zA-Z_]\w*)\s*=[^=]/g;
        while ((match = globalRegex.exec(text)) !== null) {
            const w = match[1];
            if (!foundWords.has(w)) {
                suggestions.push({ label: w, kind: monaco.languages.CompletionItemKind.Variable, detail: '(Global Variable)', insertText: w, range });
                foundWords.add(w);
            }
        }

        // 4. Scan Remaining Text (Words appearing in text)
        const textRegex = /[a-zA-Z_]\w*/g;
        while ((match = textRegex.exec(text)) !== null) {
            const w = match[0];
            if (!foundWords.has(w) && isNaN(w)) {
                suggestions.push({ label: w, kind: monaco.languages.CompletionItemKind.Text, detail: '(Text)', insertText: w, range });
                foundWords.add(w);
            }
        }
    }

    return { suggestions };
  }
});

window.editorInstance.addAction({ id: 'download', label: 'Download Script (.txt)', contextMenuGroupId: 'navigation', run: (ed) => { const name = (tabs.find(t=>t.id===activeTabId).name) + ".txt"; const blob = new Blob([ed.getValue()], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); } });
window.editorInstance.addAction({ id: 'load-script', label: 'Load Script from Device', contextMenuGroupId: 'navigation', run: () => {
    const f = document.createElement('input'); f.type = 'file'; f.accept = '.lua, .txt';
    f.onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const r = new FileReader(); r.onload = (ev) => { 
            const cur = tabs.find(t => t.id === activeTabId);
            if (cur) { cur.content = ev.target.result; cur.name = file.name.split('.')[0]; window.editorInstance.setValue(cur.content); window.renderTabs(); saveState(); }
        }; r.readAsText(file);
    }; f.click();
}});
window.editorInstance.addAction({ id: 'format', label: 'Format Document', contextMenuGroupId: 'navigation', run: () => window.editorInstance.getAction('editor.action.formatDocument').run() });
window.addEventListener('resize', window.updateIndicator);
});

let defPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); defPrompt = e; if(!isStandalone) document.getElementById('install-app-btn').style.display = 'flex'; });
document.getElementById('install-app-btn').onclick = async () => { if (defPrompt) { defPrompt.prompt(); const { outcome } = await defPrompt.userChoice; if (outcome === 'accepted') defPrompt = null; } };
</script>
</body>
</html>


