<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover, shrink-to-fit=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<title>Roblox Monaco IDE Pro</title>

<style>
:root {
  --bg-dark: #121212;
  --bg-panel: #1e1e1e;
  --bg-header: rgba(24, 24, 24, 0.85);
  --accent: #0078d4;
  --text-main: #e1e1e1;
  --text-dim: #888888;
  --border: #2a2a2a;
}

html, body {
  margin: 0; padding: 0; width: 100%; height: 100%;
  background: var(--bg-dark); overflow: hidden;
  font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
  -webkit-text-size-adjust: 100%; touch-action: none; 
}

/* --- Premium Animations --- */
@keyframes slideDownHeader {
  from { transform: translateY(-100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Editor Slide Animations */
.slide-left-out { animation: slideLeftOut 0.25s forwards cubic-bezier(0.4, 0, 0.2, 1); }
.slide-left-in { animation: slideLeftIn 0.25s forwards cubic-bezier(0.4, 0, 0.2, 1); }
.slide-right-out { animation: slideRightOut 0.25s forwards cubic-bezier(0.4, 0, 0.2, 1); }
.slide-right-in { animation: slideRightIn 0.25s forwards cubic-bezier(0.4, 0, 0.2, 1); }

@keyframes slideLeftOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-30px); opacity: 0; } }
@keyframes slideLeftIn { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideRightOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(30px); opacity: 0; } }
@keyframes slideRightIn { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* --- Header Section --- */
#header {
  height: 52px; background: var(--bg-header);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; border-bottom: 1px solid var(--border);
  animation: slideDownHeader 0.7s cubic-bezier(0.16, 1, 0.3, 1);
  z-index: 1000;
}
.brand { color: var(--text-main); font-size: 14px; font-weight: 800; letter-spacing: 2px; }
.controls { display: flex; align-items: center; gap: 12px; }

#install-app-btn {
  background: rgba(255,255,255,0.05);
  color: var(--text-main);
  border: 1px solid var(--border);
  padding: 0 12px; height: 32px; border-radius: 8px;
  cursor: pointer; display: none; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 700; transition: all 0.2s;
  text-transform: uppercase;
}
#install-app-btn:hover { background: var(--accent); border-color: var(--accent); color: #fff; }

.zoom-group {
  display: flex; gap: 4px; background: rgba(255,255,255,0.05);
  padding: 4px; border-radius: 10px; border: 1px solid var(--border);
}
.zoom-btn {
  background: transparent; color: #fff; border: none;
  width: 32px; height: 32px; border-radius: 7px;
  cursor: pointer; font-size: 18px; display: flex;
  align-items: center; justify-content: center; transition: 0.2s;
}
.zoom-btn:hover { background: var(--accent); }

/* --- Tab Bar Section --- */
#tab-bar {
  height: 42px; background: #181818;
  display: flex; align-items: center; border-bottom: 1px solid var(--border);
  overflow-x: auto; scrollbar-width: none; position: relative;
}
#tab-bar::-webkit-scrollbar { display: none; }
#tabs-container { display: flex; height: 100%; position: relative; }

.tab {
  height: 100%; display: flex; align-items: center;
  padding: 0 22px; color: var(--text-dim); font-size: 12px;
  cursor: pointer; background: transparent; border-right: 1px solid rgba(255,255,255,0.03);
  min-width: 100px; max-width: 200px; user-select: none;
  transition: color 0.3s;
  position: relative; z-index: 2;
}
.tab.active { color: #fff; }
.tab-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* à¹€à¸‰à¸žà¸²à¸° Indicator à¸—à¸µà¹ˆà¹€à¸¥à¸·à¹ˆà¸­à¸™à¸ªà¹„à¸¥à¸”à¹Œ */
#tab-indicator {
  position: absolute; bottom: 0; height: 3px;
  background: var(--accent); box-shadow: 0 -2px 10px var(--accent);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1; border-radius: 3px 3px 0 0;
}

#add-tab-btn {
  padding: 0 16px; height: 100%; background: transparent;
  border: none; color: #555; font-size: 24px;
  cursor: pointer; transition: 0.3s; z-index: 10;
}
#add-tab-btn:hover { color: #fff; transform: scale(1.2); }

/* --- Editor Area --- */
#container-viewport { width: 100%; height: calc(100% - 94px); background: var(--bg-dark); overflow: hidden; position: relative; }
#container { width: 100%; height: 100%; }

/* --- Context Menu (Tabs) --- */
#tab-menu {
  position: fixed; background: rgba(28, 28, 28, 0.98);
  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--border); border-radius: 14px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.6); padding: 8px; min-width: 200px; z-index: 10001;
  display: none; transform-origin: top left;
}
.menu-group { display: flex; flex-direction: column; gap: 4px; }
.menu-item {
  padding: 12px 16px; color: #eee; font-size: 13px;
  border-radius: 10px; cursor: pointer; display: flex;
  align-items: center; justify-content: space-between;
}
.menu-item:hover { background: var(--accent); color: #fff; }
.menu-item.danger:hover { background: #ff3b30; }

.rename-ui { padding: 8px; display: none; }
.rename-ui input {
  width: 100%; box-sizing: border-box; padding: 12px;
  background: #121212; border: 1px solid #444; color: #fff;
  border-radius: 8px; outline: none; font-size: 14px; margin-bottom: 12px;
}
.btn-row { display: flex; gap: 8px; }
.btn-row button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; }
.btn-apply { background: var(--accent); color: #fff; }
.btn-back { background: #333; color: #ccc; }

.monaco-editor .inputarea.ime-input { font-size: 16px !important; }
input, textarea { font-size: 16px !important; }
@viewport { width: device-width; zoom: 1.0; }
</style>
</head>

<body>
<div id="header">
    <div class="brand">ROBLOX IDE PRO</div>
    <div class="controls">
        <button id="install-app-btn" title="à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¸¥à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡">
            <span>ðŸ“¥</span> Install App
        </button>
        <div class="zoom-group">
            <button class="zoom-btn" id="zoom-out-btn">âˆ’</button>
            <button class="zoom-btn" id="zoom-in-btn">+</button>
        </div>
    </div>
</div>
<div id="tab-bar">
    <div id="tabs-container"></div>
    <div id="tab-indicator"></div>
    <button id="add-tab-btn">+</button>
</div>
<div id="container-viewport">
    <div id="container"></div>
</div>

<div id="tab-menu">
    <div class="menu-group" id="main-menu-group">
        <div class="menu-item" id="menu-rename">Rename Script <span>âœŽ</span></div>
        <div class="menu-item danger" id="menu-delete">Delete Tab <span>ðŸ—‘</span></div>
    </div>
    <div class="rename-ui" id="rename-section">
        <input type="text" id="inner-rename-input" spellcheck="false" autocomplete="off">
        <div class="btn-row">
            <button class="btn-back" id="rename-cancel">Back</button>
            <button class="btn-apply" id="rename-apply">Save</button>
        </div>
    </div>
</div>

<script>
/* ==========================================================
   INSTANT UI RENDERER (Render before Monaco loads)
   ========================================================== */
const TABS_KEY = 'roblox_tabs_master_v15';
const ACTIVE_ID_KEY = 'active_tab_id_v15';
const ZOOM_KEY = 'roblox_editor_zoom_v1';
const DEFAULT_CODE = 'print("Hello World")';

let tabs = JSON.parse(localStorage.getItem(TABS_KEY)) || [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE }];
let activeTabId = parseInt(localStorage.getItem(ACTIVE_ID_KEY)) || tabs[0].id;
let currentFontSize = parseInt(localStorage.getItem(ZOOM_KEY)) || 16;
let targetTabId = null;

function updateIndicator() {
    const activeTabEl = document.querySelector('.tab.active');
    const indicator = document.getElementById('tab-indicator');
    if (activeTabEl && indicator) {
        indicator.style.width = activeTabEl.offsetWidth + 'px';
        indicator.style.left = activeTabEl.offsetLeft + 'px';
    }
}

function renderTabs() {
    const container = document.getElementById('tabs-container');
    container.innerHTML = '';
    tabs.forEach(tab => {
        const div = document.createElement('div');
        div.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
        div.innerHTML = `<span class="tab-name">${tab.name}</span>`;
        
        let pressTimer;
        const startPress = (e) => {
            const pos = e.touches ? e.touches[0] : e;
            pressTimer = setTimeout(() => showTabMenu(tab.id, pos.clientX, pos.clientY), 600);
        };
        const endPress = () => clearTimeout(pressTimer);
        
        div.addEventListener('mousedown', startPress);
        div.addEventListener('mouseup', endPress);
        div.addEventListener('touchstart', startPress);
        div.addEventListener('touchend', endPress);
        div.onclick = () => window.switchTab(tab.id);
        container.appendChild(div);
    });
    setTimeout(updateIndicator, 10);
}

// à¹€à¸£à¸µà¸¢à¸ Render à¸—à¸±à¸™à¸—à¸µà¸—à¸µà¹ˆà¸­à¹ˆà¸²à¸™à¸–à¸¶à¸‡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
renderTabs();

/* ==========================================================
   PWA & ENVIRONMENT DETECTION
   ========================================================== */
const getIsStandalone = () => window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
if (getIsStandalone()) document.getElementById('install-app-btn')?.remove();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
<script>
/* ==========================================================
   PWA AUTO UPDATE
   ========================================================== */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => {
            reg.update();
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') reg.update(); });
            if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
            });
        });
    });
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => { if (!refreshing) { window.location.reload(); refreshing = true; } });
}

require.config({ paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'} });

require(['vs/editor/editor.main'],()=>{

const API={
  game:{props:['Workspace','Players','Lighting','ReplicatedStorage','ServerStorage','StarterGui','StarterPack','RunService','TweenService','UserInputService','HttpService','DataStoreService','Debris','Teams','PathfindingService','CollectionService','MarketplaceService','TeleportService','Chat','SoundService','LogService','BadgeService','AssetService','AnalyticsService','SocialService'],methods:['GetService','BindToClose','IsLoaded','Shutdown','IsAncestorOf','IsDescendantOf','GetObjects']},
  Workspace:{props:['CurrentCamera','Terrain','Gravity','GlobalWind','FallenPartsDestroyHeight','StreamingEnabled','DistributedGameTime'],methods:['Raycast','GetPartBoundsInBox','GetPartsInPart','GetPartBoundsInRadius','FindPartOnRay','FindPartOnRayWithIgnoreList','BulkMoveTo','GetRealtimeVelocityAtPoint']},
  Players:{props:['LocalPlayer','MaxPlayers','RespawnTime','PlayerAdded','PlayerRemoving'],methods:['GetPlayers','GetPlayerFromCharacter','GetNameFromUserIdAsync','GetUserIdFromNameAsync','GetUserThumbnailAsync','CreateHumanoidModelFromUserId','BanAsync','UnbanAsync']},
  Lighting:{props:['Ambient','Brightness','ColorShift_Bottom','ColorShift_Top','GlobalShadows','OutdoorAmbient','Outlines','ShadowShadowSoftness','ClockTime','GeographicLatitude','ExposureCompensation','FogColor','FogEnd','FogStart','EnvironmentDiffuseScale','EnvironmentSpecularScale'],methods:['SetMinutesAfterMidnight','GetMinutesAfterMidnight']},
  Instance:{props:['Name','Parent','ClassName','Archivable'],methods:['new','Destroy','Clone','FindFirstChild','WaitForChild','GetChildren','GetDescendants','IsA','GetPropertyChangedSignal','SetAttribute','GetAttribute','ClearAllChildren','IsDescendantOf','GetFullName','RemoveAttribute','GetAttributes']},
  Player:{props:['Name','UserId','Character','Backpack','PlayerGui','Team','DisplayName','AccountAge','LocaleId','MembershipType','FollowUserId','RespawnLocation','CharacterAdded','CharacterRemoving'],methods:['Kick','LoadCharacter','GetMouse','IsInGroup','GetRankInGroup','GetRoleInGroup','ClearCharacterAppearance','HasAppearanceLoaded','Move','SetCanSelfTerminate']},
  Humanoid:{props:['Health','MaxHealth','WalkSpeed','JumpPower','JumpHeight','HipHeight','Sit','MoveDirection','PlatformStand','AutoRotate','UseJumpPower','DisplayName','HealthDisplayType','Died','StateChanged','ClimbSpeed','FloorMaterial'],methods:['TakeDamage','Move','MoveTo','EquipTool','UnequipTools','ChangeState','GetState','LoadAnimation','AddCustomStatus','ApplyDescription']},
  BasePart:{props:['Anchored','CanCollide','CanTouch','CanQuery','Transparency','Reflectance','Color','Material','Position','Size','CFrame','Velocity','AssemblyLinearVelocity','AssemblyAngularVelocity','Mass','Orientation','Shape','Locked','CastShadow','CollisionGroup','PivotOffset','Touched','TouchEnded','Changed'],methods:['ApplyImpulse','GetMass','SetNetworkOwner','GetNetworkOwner','BreakJoints','GetRootPart','GetConnectedParts','ApplyAngularImpulse','Resize','TranslateBy','Subtract','Union','Intersect']},
  TweenService:{props:[],methods:['Create','GetValue']},
  RunService:{props:['Heartbeat','RenderStepped','Stepped'],methods:['IsClient','IsServer','IsStudio','IsRunning']},
  RemoteEvent:{props:['OnServerEvent','OnClientEvent'],methods:['FireServer','FireClient','FireAllClients']},
  Sound:{props:['Playing','Paused','TimePosition','Volume','Pitch','PlaybackSpeed','Looped','SoundId'],methods:['Play','Stop','Pause','Resume']},
  Camera:{props:['CFrame','Focus','FieldOfView','CameraType','ViewportSize','NearPlaneZ'],methods:['WorldToViewportPoint','WorldToScreenPoint','ViewportPointToRay','ScreenPointToRay']},
  UserInputService:{props:['KeyboardEnabled','MouseEnabled','TouchEnabled','GamepadEnabled','AccelerometerEnabled','GyroscopeEnabled','InputBegan','InputEnded','InputChanged'],methods:['GetKeysPressed','IsKeyDown','IsMouseButtonPressed','GetFocusedTextBox']},
  HttpService:{props:['HttpEnabled'],methods:['GetAsync','PostAsync','JSONEncode','JSONDecode','GenerateGUID']}
};
const DATA_TYPES={
  Vector3:{props:['X','Y','Z','Magnitude','Unit'],methods:['Lerp','Dot','Cross','FuzzyEq','Max','Min'],static:['new','zero','one','xAxis','yAxis','zAxis']},
  CFrame:{props:['Position','LookVector','RightVector','UpVector','X','Y','Z','p'],methods:['Lerp','Inverse','ToObjectSpace','ToWorldSpace','ToEulerAnglesXYZ','ToOrientation','ToAxisAngle','GetComponents'],static:['new','Angles','lookAt','fromAxisAngle','fromMatrix','fromOrientation','fromEulerAnglesXYZ']},
  Color3:{props:['R','G','B'],methods:['ToHSV','Lerp'],static:['new','fromRGB','fromHSV','fromHex']},
  UDim2:{props:['X','Y'],methods:['Lerp'],static:['new','fromScale','fromOffset']},
  DateTime:{props:['UnixTimestamp','UnixTimestampMillis'],methods:['FormatLocalTime','FormatUniversalTime','ToUniversalTime','ToISO8601'],static:['now','fromUnixTimestamp','fromISO8601']},
  Ray:{props:['Origin','Direction','Unit'],methods:['ClosestPoint','Distance'],static:['new']},
  Region3:{props:['CFrame','Size'],static:['new']},
  Rect:{props:['Min','Max'],static:['new']},
  Font:{props:['Family','Weight'],static:['new','fromId']},
  Axes:{props:['X','Y','Z'],static:['new']},
  Faces:{props:['Top','Bottom'],static:['new']}
};
const LUA_LIBS={table:{methods:['insert','remove','sort','concat','find']},math:{methods:['abs','acos','asin','ceil','cos','deg','exp','floor','max','min','pow','rad','random','sin','sqrt','tan','clamp','huge','pi']},task:{methods:['wait','spawn','defer','delay','cancel']}};
const GLOBAL_FUNCS=['print','warn','error','wait','spawn','delay','tick','time','typeof','type','pairs','ipairs','pcall','xpcall','assert','require','tostring','tonumber','task','shared','_G'];
const SNIPPETS=[{label:'if',insertText:'if ${1:condition} then\n\t$0\nend'},{label:'function',insertText:'function ${1:name}(${2:params})\n\t$0\nend'},{label:'fori',insertText:'for ${1:i} = ${2:1}, ${3:10} do\n\t$0\nend'}];
const LUA_KEYWORDS=['local','function','if','then','elseif','else','for','while','repeat','until','do','end','return','break','continue','and','or','not','true','false','nil','in'];
const COMMON=['Destroy','Clone','FindFirstChild','WaitForChild','GetChildren','GetDescendants','IsA','Connect','Wait','Once','Disconnect','GetPropertyChangedSignal','SetAttribute','GetAttribute','IsDescendantOf','GetFullName'];

const editor = monaco.editor.create(document.getElementById('container'), {
    value: (tabs.find(t => t.id === activeTabId) || tabs[0]).content,
    language: 'lua', theme: 'vs-dark', fontSize: currentFontSize, automaticLayout: true,
    minimap: { enabled: false }, cursorSmoothCaretAnimation: true,
    smoothScrolling: true, wordWrap: "on", fixedOverflowWidgets: true, links: false
});

function saveState() {
    localStorage.setItem(TABS_KEY, JSON.stringify(tabs));
    localStorage.setItem(ACTIVE_ID_KEY, activeTabId.toString());
    localStorage.setItem(ZOOM_KEY, currentFontSize.toString());
}

document.getElementById('zoom-in-btn').onclick = () => adjustZoom(2);
document.getElementById('zoom-out-btn').onclick = () => adjustZoom(-2);

function adjustZoom(amount) {
    currentFontSize = Math.max(10, Math.min(40, currentFontSize + amount));
    editor.updateOptions({ fontSize: currentFontSize });
    saveState();
}

window.switchTab = (id) => {
    if (id === activeTabId) return;
    const oldIndex = tabs.findIndex(t => t.id === activeTabId);
    const newIndex = tabs.findIndex(t => t.id === id);
    const direction = newIndex > oldIndex ? 'left' : 'right';
    const container = document.getElementById('container');
    if(tabs[oldIndex]) tabs[oldIndex].content = editor.getValue();
    container.className = direction === 'left' ? 'slide-left-out' : 'slide-right-out';
    setTimeout(() => {
        activeTabId = id;
        editor.setValue(tabs[newIndex].content);
        container.className = direction === 'left' ? 'slide-left-in' : 'slide-right-in';
        saveState(); renderTabs();
        setTimeout(() => { container.className = ''; }, 250);
    }, 150);
};

document.getElementById('add-tab-btn').onclick = () => {
    const cur = tabs.find(t => t.id === activeTabId);
    if(cur) cur.content = editor.getValue();
    const newId = Date.now();
    tabs.push({ id: newId, name: `Script ${tabs.length + 1}`, content: DEFAULT_CODE });
    activeTabId = newId;
    const container = document.getElementById('container');
    container.className = 'slide-left-out';
    setTimeout(() => {
        editor.setValue(DEFAULT_CODE);
        container.className = 'slide-left-in';
        saveState(); renderTabs();
        setTimeout(() => { container.className = ''; }, 250);
    }, 150);
};

/* --- Context Menu Logic --- */
const menu = document.getElementById('tab-menu');
const mainMenu = document.getElementById('main-menu-group');
const renameSection = document.getElementById('rename-section');
const renameInput = document.getElementById('inner-rename-input');

window.showTabMenu = (id, x, y) => {
    targetTabId = id;
    mainMenu.style.display = 'block';
    renameSection.style.display = 'none';
    menu.style.display = 'block';
    if (x + 200 > window.innerWidth) x -= 200;
    menu.style.left = x + 'px'; menu.style.top = y + 'px';
};

document.addEventListener('mousedown', (e) => { if (!menu.contains(e.target)) menu.style.display = 'none'; });

document.getElementById('menu-rename').onclick = () => {
    const tab = tabs.find(t => t.id === targetTabId);
    mainMenu.style.display = 'none';
    renameSection.style.display = 'block';
    renameInput.value = tab.name;
    renameInput.focus(); renameInput.select();
};

document.getElementById('rename-cancel').onclick = (e) => {
    e.stopPropagation(); mainMenu.style.display = 'block'; renameSection.style.display = 'none';
};

document.getElementById('rename-apply').onclick = (e) => {
    e.stopPropagation();
    const newName = renameInput.value.trim();
    if (newName) {
        tabs.find(t => t.id === targetTabId).name = newName;
        saveState(); renderTabs();
    }
    menu.style.display = 'none';
};

document.getElementById('menu-delete').onclick = () => {
    menu.style.display = 'none';
    tabs = tabs.filter(t => t.id !== targetTabId);
    if (tabs.length === 0) tabs = [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE }];
    if (activeTabId === targetTabId) {
        activeTabId = tabs[0].id; editor.setValue(tabs[0].content);
    }
    saveState(); renderTabs();
};

document.getElementById('install-app-btn').onclick = async () => {
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') deferredPrompt = null;
    }
};

editor.onDidChangeModelContent(() => {
    const current = tabs.find(t => t.id === activeTabId);
    if (current) { current.content = editor.getValue(); saveState(); }
});

/* --- Roblox IntelliSense Provider --- */
monaco.languages.registerCompletionItemProvider('lua', {
  triggerCharacters: ['.', ':', '"', "'"],
  provideCompletionItems(model, pos) {
    const line = model.getLineContent(pos.lineNumber);
    const before = line.slice(0, pos.column);
    const word = model.getWordUntilPosition(pos);
    const range = { startLineNumber: pos.lineNumber, endLineNumber: pos.lineNumber, startColumn: word.startColumn, endColumn: word.endColumn };
    const m = before.match(/([\w\.:"'\(\)]+)([\.:])$/);
    if (m) {
      const type = m[1]; const colon = m[2] === ':';
      if (API[type]) {
        const out = [];
        if (!colon) API[type].props.forEach(p => out.push({ label: p, kind: monaco.languages.CompletionItemKind.Property, insertText: p, range }));
        API[type].methods.concat(COMMON).forEach(fn => out.push({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        return { suggestions: out };
      }
      if (DATA_TYPES[type]) {
        const d = DATA_TYPES[type]; const out = [];
        if (!colon) {
            d.props.forEach(p => out.push({ label: p, kind: monaco.languages.CompletionItemKind.Property, insertText: p, range }));
            if (d.static) d.static.forEach(s => out.push({ label: s, kind: monaco.languages.CompletionItemKind.Method, insertText: s + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        }
        if (d.methods) d.methods.forEach(fn => out.push({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        return { suggestions: out };
      }
    }
    const suggestions = [];
    LUA_KEYWORDS.forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Keyword, insertText: k, range }));
    GLOBAL_FUNCS.forEach(f => suggestions.push({ label: f, kind: monaco.languages.CompletionItemKind.Function, insertText: f + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
    SNIPPETS.forEach(s => suggestions.push({ label: s.label, kind: monaco.languages.CompletionItemKind.Snippet, insertText: s.insertText, insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
    Object.keys(API).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Class, insertText: k, range }));
    Object.keys(DATA_TYPES).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Struct, insertText: k, range }));
    return { suggestions };
  }
});

// Monaco Menu Actions
editor.addAction({ 
    id: 'download-script', label: 'Download Current Tab (.txt)', contextMenuGroupId: 'navigation', 
    run: (ed) => { 
        const name = (tabs.find(t=>t.id===activeTabId).name) + ".txt"; 
        const blob = new Blob([ed.getValue()], { type: 'text/plain' }); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); 
    } 
});

editor.addAction({ 
    id: 'load-script', label: 'Load Script from Device', contextMenuGroupId: 'navigation', 
    run: () => {
        const f = document.createElement('input'); f.type = 'file'; f.accept = '.lua, .txt';
        f.onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const r = new FileReader(); 
            r.onload = (ev) => { 
                const content = ev.target.result;
                const cur = tabs.find(t => t.id === activeTabId);
                if (cur) {
                    cur.content = content; cur.name = file.name.split('.')[0]; 
                    editor.setValue(content); renderTabs(); saveState();
                }
            }; 
            r.readAsText(file);
        };
        f.click();
    } 
});

editor.addAction({ id: 'format', label: 'Format Document', contextMenuGroupId: 'navigation', keybindings: [monaco.KeyMod.Shift | monaco.KeyMod.Alt | monaco.KeyCode.KeyF], run: () => editor.getAction('editor.action.formatDocument').run() });

window.addEventListener('resize', updateIndicator);
});
</script>
</body>
</html>

