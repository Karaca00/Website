<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover, shrink-to-fit=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<title>Editor IDE Master</title>

<!-- Firebase Legacy SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg-dark: #121212; --bg-panel: #1e1e1e; --bg-header: rgba(24, 24, 24, 0.85);
  --accent: #0078d4; --text-main: #e1e1e1; --text-dim: #888888; --border: #2a2a2a;
}
html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-dark); overflow: hidden; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; -webkit-text-size-adjust: 100%; touch-action: none; }

/* Animations */
@keyframes slideDownHeader { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.slide-left-out { animation: slideLeftOut 0.2s forwards; }
.slide-left-in { animation: slideLeftIn 0.2s forwards; }
@keyframes slideLeftOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-20px); opacity: 0; } }
@keyframes slideLeftIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* UI Parts */
#header { height: 52px; background: var(--bg-header); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid var(--border); animation: slideDownHeader 0.7s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1000; }
.brand { color: var(--text-main); font-size: 14px; font-weight: 800; letter-spacing: 2px; }
.controls { display: flex; align-items: center; gap: 8px; }

.header-btn { background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border); padding: 0 10px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 700; transition: all 0.2s; text-transform: uppercase; white-space: nowrap; }
.header-btn:hover { background: var(--accent); border-color: var(--accent); color: #fff; }
#auth-btn { background: #333; border-color: #444; }

.zoom-group { display: flex; gap: 4px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
.zoom-btn { background: transparent; color: #fff; border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }

#tab-bar { height: 42px; background: #181818; display: flex; align-items: center; border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; position: relative; }
#tab-bar::-webkit-scrollbar { display: none; }
#tabs-container { display: flex; height: 100%; position: relative; }

.tab { height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 8px 0 18px; color: var(--text-dim); font-size: 12px; cursor: pointer; background: transparent; border-right: 1px solid rgba(255,255,255,0.03); min-width: 120px; max-width: 220px; user-select: none; transition: color 0.3s; position: relative; z-index: 2; }
.tab.active { color: #fff; }
.tab-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 8px; }

.tab-options-btn { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 6px; color: #555; transition: 0.2s; flex-shrink: 0; }
.tab-options-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

#tab-indicator { position: absolute; bottom: 0; height: 3px; background: var(--accent); box-shadow: 0 -2px 10px var(--accent); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; border-radius: 3px 3px 0 0; }
#add-tab-btn { padding: 0 16px; height: 100%; background: transparent; border: none; color: #555; font-size: 24px; cursor: pointer; transition: 0.3s; z-index: 10; }
#add-tab-btn:hover { color: #fff; transform: scale(1.2); }

#container-viewport { width: 100%; height: calc(100% - 94px); background: var(--bg-dark); overflow: hidden; position: relative; }
#container { width: 100%; height: 100%; }

/* Modal System */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(10px); }
.modal-box { background: var(--bg-panel); width: 300px; padding: 30px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 30px 80px rgba(0,0,0,0.9); }
.modal-box h3 { margin: 0 0 25px; font-size: 15px; text-align: center; color: var(--accent); font-weight: 800; }
.modal-box input { width: 100%; box-sizing: border-box; padding: 14px; margin-bottom: 15px; background: #121212; border: 1px solid #333; color: #fff; border-radius: 12px; outline: none; }

#tab-menu { position: fixed; background: rgba(28, 28, 28, 0.98); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); padding: 8px; min-width: 180px; z-index: 10001; display: none; }
.menu-item { padding: 10px 14px; color: #eee; font-size: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
.menu-item:hover { background: var(--accent); color: #fff; }
.menu-item.danger:hover { background: #ff3b30; }

.monaco-editor .scroll-decoration { display: none; }
input, textarea { font-size: 16px !important; }
@viewport { width: device-width; zoom: 1.0; }
</style>
</head>

<body>
<div id="header">
    <div class="brand">Editor MASTER</div>
    <div class="controls">
        <button id="auth-btn" class="header-btn" onclick="window.handleAccountAction()"><span>ðŸ‘¤</span> LOGIN</button>
        <button id="install-app-btn" class="header-btn" title="à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸­à¸›"><span>ðŸ“¥</span> INSTALL</button>
        <div class="zoom-group">
            <button class="zoom-btn" id="zoom-out-btn">âˆ’</button>
            <button class="zoom-btn" id="zoom-in-btn">+</button>
        </div>
    </div>
</div>
<div id="tab-bar"><div id="tabs-container"></div><div id="tab-indicator"></div><button id="add-tab-btn">+</button></div>
<div id="container-viewport"><div id="container"></div></div>

<!-- Auth Modal -->
<div id="auth-modal" class="modal-overlay" onclick="if(event.target==this) window.closeAuthModal()">
    <div class="modal-box">
        <h3 id="auth-title">SYNC WITH CLOUD</h3>
        <input type="text" id="auth-user" placeholder="Username (Min 3 chars)">
        <input type="password" id="auth-pass" placeholder="Password (Min 6 chars)">
        <button class="btn-primary" style="width:100%; padding:14px; border:none; border-radius:12px; background:var(--accent); color:#fff; font-weight:700; cursor:pointer;" onclick="window.handleAuth()">Confirm</button>
        <button class="btn-secondary" style="width:100%; padding:10px; border:none; border-radius:8px; background:transparent; color:#777; cursor:pointer; font-size:11px; margin-top:5px;" id="auth-switch" onclick="window.switchAuthMode()">No account? Create one</button>
        <button class="btn-secondary" style="width:100%; padding:10px; border:none; border-radius:8px; background:transparent; color:#777; cursor:pointer; font-size:11px;" onclick="window.closeAuthModal()">Cancel</button>
    </div>
</div>

<!-- Tab Context Menu -->
<div id="tab-menu">
    <div id="main-menu-group">
        <div class="menu-item" id="menu-rename">Rename Script âœŽ</div>
        <div class="menu-item danger" id="menu-delete">Delete Tab ðŸ—‘</div>
    </div>
    <div id="rename-section" style="display:none; padding:8px;">
        <input type="text" id="inner-rename-input" style="width:100%; margin-bottom:10px; background:#121212; color:#fff; border:1px solid #444; padding:8px; border-radius:6px;">
        <div style="display:flex; gap:5px;"><button id="rename-cancel" style="flex:1; padding:5px; background:#333; color:#fff; border:none; border-radius:4px;">Back</button><button id="rename-apply" style="flex:1; padding:5px; background:var(--accent); color:#fff; border:none; border-radius:4px;">Save</button></div>
    </div>
</div>

<script>
/* ==========================================================
   FIREBASE CORE & SYNC LOGIC
   ========================================================== */
const firebaseConfig = {
    apiKey: "AIzaSyCdbYqWYST57jJRR2SBi05hFonp1AlK180",
    authDomain: "webapp-karaca.firebaseapp.com",
    projectId: "webapp-karaca",
    storageBucket: "webapp-karaca.firebasestorage.app",
    messagingSenderId: "244265873424",
    appId: "1:244265873424:web:ad4c9f31b438a8c9c49a95",
    measurementId: "G-9P9SFP89RC"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const appId = typeof __app_id !== 'undefined' ? __app_id : 'roblox-ide-master';
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let currentUser = null;
let isRegisterMode = false;

/* UI State Keys */
const TABS_KEY = 'roblox_tabs_master_v32';
const ACTIVE_ID_KEY = 'active_tab_id_v32';
const ZOOM_KEY = 'roblox_master_zoom_v1';
const DEFAULT_CODE = 'print("Hello Roblox Cloud")';

let tabs = JSON.parse(localStorage.getItem(TABS_KEY)) || [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE }];
let activeTabId = parseInt(localStorage.getItem(ACTIVE_ID_KEY)) || tabs[0].id;
let currentFontSize = parseInt(localStorage.getItem(ZOOM_KEY)) || 16;
let targetTabId = null;

/* --- UI Handlers --- */
window.updateIndicator = () => {
    const el = document.querySelector('.tab.active');
    const ind = document.getElementById('tab-indicator');
    if (el && ind) { ind.style.width = el.offsetWidth + 'px'; ind.style.left = el.offsetLeft + 'px'; }
};

window.renderTabs = () => {
    const container = document.getElementById('tabs-container');
    container.innerHTML = '';
    tabs.forEach(tab => {
        const div = document.createElement('div');
        div.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
        div.innerHTML = `<span class="tab-name">${tab.name}</span><div class="tab-options-btn">â‰¡</div>`;
        div.onclick = (e) => { if(!e.target.classList.contains('tab-options-btn')) window.switchTab(tab.id); };
        const optBtn = div.querySelector('.tab-options-btn');
        optBtn.onclick = (e) => { e.stopPropagation(); const rect = optBtn.getBoundingClientRect(); window.showTabMenu(tab.id, rect.left - 150, rect.bottom + 5); };
        container.appendChild(div);
    });
    setTimeout(window.updateIndicator, 20);
};

/* --- ULTRA FAST UPDATE ENGINE --- */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => {
            reg.update(); // à¹€à¸Šà¹‡à¸„à¸—à¸±à¸™à¸—à¸µ
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') reg.update(); // à¹€à¸Šà¹‡à¸„à¹€à¸¡à¸·à¹ˆà¸­à¸à¸¥à¸±à¸šà¸¡à¸²à¸—à¸µà¹ˆà¹à¸­à¸›
            });
            if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        });
    });
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) { window.location.reload(); refreshing = true; } // à¸£à¸µà¹‚à¸«à¸¥à¸”à¸—à¸±à¸™à¸—à¸µà¸—à¸µà¹ˆà¹€à¸ˆà¸­à¸•à¸±à¸§à¹ƒà¸«à¸¡à¹ˆ
    });
}

/* --- Auth Logic --- */
window.handleAccountAction = () => {
    if (currentUser) {
        if (confirm(`User: ${currentUser.username}\nLogout and Clear Sync?`)) {
            auth.signOut().then(() => { localStorage.clear(); window.location.reload(); });
        }
        return;
    }
    document.getElementById('auth-modal').style.display = 'flex';
};
window.closeAuthModal = () => document.getElementById('auth-modal').style.display = 'none';
window.switchAuthMode = () => {
    isRegisterMode = !isRegisterMode;
    document.getElementById('auth-title').innerText = isRegisterMode ? "CREATE CLOUD ACCOUNT" : "SYNC WITH CLOUD";
    document.getElementById('auth-switch').innerText = isRegisterMode ? "Back to Login" : "No account? Create one";
};
window.handleAuth = async () => {
    const userPart = document.getElementById('auth-user').value.trim();
    const pass = document.getElementById('auth-pass').value;
    if (userPart.length < 3 || pass.length < 6) return alert("User 3, Pass 6");
    const email = `${userPart.toLowerCase()}@master.ide`;
    try {
        if (isRegisterMode) {
            const res = await auth.createUserWithEmailAndPassword(email, pass);
            await db.doc(`artifacts/${appId}/users/${res.user.uid}/data/state`).set({ tabs, activeTabId, lastSync: Date.now(), username: userPart });
        } else {
            await auth.signInWithEmailAndPassword(email, pass);
        }
        window.closeAuthModal();
    } catch (e) { alert(e.message); }
};

auth.onAuthStateChanged(async (user) => {
    const btn = document.getElementById('auth-btn');
    if (user) {
        currentUser = { uid: user.uid, username: user.email.split('@')[0] };
        btn.innerHTML = `<span>ðŸ‘¤</span> ${currentUser.username.toUpperCase()}`;
        const doc = await db.doc(`artifacts/${appId}/users/${user.uid}/data/state`).get();
        if (doc.exists) {
            const data = doc.data();
            tabs = data.tabs; activeTabId = data.activeTabId;
            if (window.editorInstance) window.editorInstance.setValue(tabs.find(t => t.id === activeTabId).content);
            window.renderTabs();
        }
    } else { currentUser = null; btn.innerHTML = `<span>ðŸ‘¤</span> LOGIN`; }
});

const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
window.addEventListener('DOMContentLoaded', () => {
    window.renderTabs();
    if (isStandalone) document.getElementById('install-app-btn')?.remove();
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
<script>
/* Monaco Engine (Internal Worker Fix for Apps) */
const workerBlob = new Blob([`
    self.MonacoEnvironment = { baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/' };
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/base/worker/workerMain.js');
`], { type: 'application/javascript' });
window.MonacoEnvironment = { getWorkerUrl: () => URL.createObjectURL(workerBlob) };

require.config({ paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'} });

require(['vs/editor/editor.main'],()=>{
/* ==========================================================
   ULTIMATE MEGA ROBLOX API DATABASE (700+ Lines Uncut)
   ========================================================== */
const API={
  game:{props:['Workspace','Players','Lighting','ReplicatedStorage','ServerStorage','StarterGui','StarterPack','RunService','TweenService','UserInputService','HttpService','DataStoreService','Debris','Teams','PathfindingService','CollectionService','MarketplaceService','TeleportService','Chat','SoundService','LogService','BadgeService','AssetService','AnalyticsService','SocialService','Selection','TestService','VRService','PolicyService','ProximityPromptService'],methods:['GetService','BindToClose','IsLoaded','Shutdown','IsAncestorOf','IsDescendantOf','GetObjects','FindService','GetJobsExtended','IsNetworkSettled','SetPlaceId','SetUniverseId']},
  Workspace:{props:['CurrentCamera','Terrain','Gravity','GlobalWind','FallenPartsDestroyHeight','StreamingEnabled','DistributedGameTime','AllowAudioIsolation','InterpolationThrottling','SignalBehavior'],methods:['Raycast','GetPartBoundsInBox','GetPartsInPart','GetPartBoundsInRadius','FindPartOnRay','FindPartOnRayWithIgnoreList','BulkMoveTo','GetRealtimeVelocityAtPoint','FindPartOnRayWithWhitelist','Spherecast','Blockcast','Shapecast']},
  Players:{props:['LocalPlayer','MaxPlayers','RespawnTime','PlayerAdded','PlayerRemoving','CharacterAutoLoads','BubbleChat','PreferredPlayersCount'],methods:['GetPlayers','GetPlayerFromCharacter','GetNameFromUserIdAsync','GetUserIdFromNameAsync','GetUserThumbnailAsync','CreateHumanoidModelFromUserId','BanAsync','UnbanAsync','GetFriendsAsync','GetUserFriendsAsync','IsFriendsWith']},
  Lighting:{props:['Ambient','Brightness','ColorShift_Bottom','ColorShift_Top','GlobalShadows','OutdoorAmbient','Outlines','ShadowShadowSoftness','ClockTime','GeographicLatitude','ExposureCompensation','FogColor','FogEnd','FogStart','EnvironmentDiffuseScale','EnvironmentSpecularScale','Technology'],methods:['SetMinutesAfterMidnight','GetMinutesAfterMidnight']},
  Instance:{props:['Name','Parent','ClassName','Archivable'],methods:['new','Destroy','Clone','FindFirstChild','WaitForChild','GetChildren','GetDescendants','IsA','GetPropertyChangedSignal','SetAttribute','GetAttribute','ClearAllChildren','IsDescendantOf','GetFullName','RemoveAttribute','GetAttributes','FindFirstAncestor','FindFirstAncestorOfClass','FindFirstAncestorWhichIsA','FindFirstChildOfClass','FindFirstChildWhichIsA']},
  Player:{props:['Name','UserId','Character','Backpack','PlayerGui','Team','DisplayName','AccountAge','LocaleId','MembershipType','FollowUserId','RespawnLocation','CharacterAdded','CharacterRemoving','SimulationRadius','DataReady'],methods:['Kick','LoadCharacter','GetMouse','IsInGroup','GetRankInGroup','GetRoleInGroup','ClearCharacterAppearance','HasAppearanceLoaded','Move','SetCanSelfTerminate','GetJoinData','GetNetworkSimulator']},
  Humanoid:{props:['Health','MaxHealth','WalkSpeed','JumpPower','JumpHeight','HipHeight','Sit','MoveDirection','PlatformStand','AutoRotate','UseJumpPower','DisplayName','HealthDisplayType','Died','StateChanged','ClimbSpeed','FloorMaterial','BreakJointsOnDeath','DisplayDistanceType','RigType'],methods:['TakeDamage','Move','MoveTo','EquipTool','UnequipTools','ChangeState','GetState','LoadAnimation','AddCustomStatus','ApplyDescription','GetAccessories','GetBodyPartR6','GetBodyPartR15']},
  BasePart:{props:['Anchored','CanCollide','CanTouch','CanQuery','Transparency','Reflectance','Color','Material','Position','Size','CFrame','Velocity','AssemblyLinearVelocity','AssemblyAngularVelocity','Mass','Orientation','Shape','Locked','CastShadow','CollisionGroup','PivotOffset','Touched','TouchEnded','Changed','LocalTransparencyModifier','CenterOfMass','ReceiveAge'],methods:['ApplyImpulse','GetMass','SetNetworkOwner','GetNetworkOwner','BreakJoints','GetRootPart','GetConnectedParts','ApplyAngularImpulse','Resize','TranslateBy','Subtract','Union','Intersect','ApplyImpulseAtPosition','GetClosestPointOnSurface']},
  TweenService:{props:[],methods:['Create','GetValue']},
  RunService:{props:['Heartbeat','RenderStepped','Stepped'],methods:['IsClient','IsServer','IsStudio','IsRunning','BindToRenderStep','UnbindFromRenderStep']},
  HttpService:{props:['HttpEnabled'],methods:['GetAsync','PostAsync','JSONEncode','JSONDecode','GenerateGUID','UrlEncode','RequestAsync']},
  DataStoreService:{props:[],methods:['GetDataStore','GetOrderedDataStore','GetGlobalDataStore','ListDataStoresAsync']},
  CollectionService:{props:[],methods:['AddTag','RemoveTag','HasTag','GetTags','GetTagged','GetInstanceAddedSignal','GetInstanceRemovedSignal']},
  TweenInfo:{static:['new'],props:['Time','EasingStyle','EasingDirection','RepeatCount','Reverses','DelayTime']},
  RemoteEvent:{props:['OnServerEvent','OnClientEvent'],methods:['FireServer','FireClient','FireAllClients']},
  RemoteFunction:{props:['OnServerInvoke','OnClientInvoke'],methods:['InvokeServer','InvokeClient']},
  Camera:{props:['CFrame','Focus','FieldOfView','CameraType','ViewportSize','NearPlaneZ'],methods:['WorldToViewportPoint','WorldToScreenPoint','ViewportPointToRay','ScreenPointToRay']},
  UserInputService:{props:['KeyboardEnabled','MouseEnabled','TouchEnabled','GamepadEnabled','AccelerometerEnabled','GyroscopeEnabled','InputBegan','InputEnded','InputChanged'],methods:['GetKeysPressed','IsKeyDown','IsMouseButtonPressed','GetFocusedTextBox']},
  Debris:{methods:['AddItem']},
  MarketplaceService:{methods:['GetProductInfo','PromptGamePassPurchase','PromptPurchase','UserOwnsGamePassAsync']},
  SoundService:{props:['AmbientReverb','DistanceFactor','RolloffScale'],methods:['GetListener']},
  LogService:{methods:['GetLogHistory']},
  BadgeService:{methods:['GetBadgeInfoAsync','AwardBadge','UserHasBadgeAsync']}
};

const DATA_TYPES={
  Vector3:{props:['X','Y','Z','Magnitude','Unit'],methods:['Dot','Cross','Lerp','FuzzyEq','Abs','Ceil','Floor','Sign','Max','Min'],static:['new','zero','one','xAxis','yAxis','zAxis']},
  Vector2:{props:['X','Y','Magnitude','Unit'],methods:['Dot','Cross','Lerp'],static:['new','zero','one']},
  CFrame:{props:['Position','LookVector','RightVector','UpVector','X','Y','Z','p','Rotation'],methods:['Lerp','Inverse','ToObjectSpace','ToWorldSpace','ToEulerAnglesXYZ','ToOrientation','ToAxisAngle','GetComponents','Inverse','Orthonormalize'],static:['new','Angles','lookAt','fromAxisAngle','fromMatrix','fromOrientation','fromEulerAnglesXYZ']},
  Color3:{props:['R','G','B'],methods:['ToHSV','Lerp'],static:['new','fromRGB','fromHSV','fromHex']},
  BrickColor:{props:['Name','Number','Color','r','g','b'],static:['new','Random','White','Black','Red','Blue','Green','Yellow','DarkGray','Gray','palette']},
  UDim2:{props:['X','Y'],methods:['Lerp'],static:['new','fromScale','fromOffset']},
  UDim:{props:['Scale','Offset'],static:['new']},
  Ray:{props:['Origin','Direction','Unit'],methods:['ClosestPoint','Distance'],static:['new']},
  Region3:{props:['CFrame','Size'],methods:['ExpandToGrid'],static:['new']},
  Rect:{props:['Min','Max','Width','Height'],static:['new']},
  ColorSequence:{props:['Keypoints'],static:['new']},
  ColorSequenceKeypoint:{props:['Time','Value'],static:['new']},
  NumberSequence:{props:['Keypoints'],static:['new']},
  NumberSequenceKeypoint:{props:['Time','Value','Envelope'],static:['new']},
  NumberRange:{props:['Min','Max'],static:['new']},
  DateTime:{props:['UnixTimestamp','UnixTimestampMillis'],methods:['FormatLocalTime','FormatUniversalTime','ToUniversalTime','ToISO8601'],static:['now','fromUnixTimestamp','fromISO8601']},
  PhysicalProperties:{props:['Density','Friction','Elasticity','FrictionWeight','ElasticityWeight'],static:['new']},
  Font:{props:['Family','Weight','Style','Bold'],static:['new','fromId']},
  Axes:{props:['X','Y','Z'],static:['new']},
  Faces:{props:['Top','Bottom','Left','Right','Back','Front'],static:['new']},
  RaycastParams:{props:['FilterDescendantsInstances','FilterType','IgnoreWater','CollisionGroup','RespectCanCollide'],static:['new']}
};

const LUA_LIBS={
  table:{methods:['insert','remove','sort','concat','find','create','clear','unpack','pack','move','freeze','isfrozen']},
  math:{methods:['abs','acos','asin','atan','atan2','ceil','cos','cosh','deg','exp','floor','fmod','frexp','ldexp','log','log10','max','min','modf','pow','rad','random','randomseed','sin','sinh','sqrt','tan','tanh','clamp','huge','pi','noise','round','sign']},
  string:{methods:['byte','char','find','format','gmatch','gsub','len','lower','match','rep','reverse','sub','upper','split','pack','unpack','packsize']},
  task:{methods:['wait','spawn','defer','delay','cancel','desynchronize','synchronize']},
  os:{methods:['time','date','difftime','clock']},
  utf8:{methods:['char','charpos','codes','codepoint','len','offset']},
  coroutine:{methods:['create','resume','running','status','wrap','yield','close','isyieldable']},
  debug:{methods:['traceback','profilebegin','profileend']}
};

const GLOBAL_FUNCS=['print','warn','error','wait','spawn','delay','tick','time','typeof','type','pairs','ipairs','pcall','xpcall','assert','require','tostring','tonumber','task','shared','_G','getfenv','setfenv','next','rawget','rawset','rawequal','select','gcinfo','collectgarbage'];

const SNIPPETS=[
  {label:'if',insertText:'if ${1:condition} then\n\t$0\nend'},
  {label:'fori',insertText:'for ${1:i} = ${2:1}, ${3:10} do\n\t$0\nend'},
  {label:'forp',insertText:'for ${1:i}, ${2:v} in pairs(${3:table}) do\n\t$0\nend'},
  {label:'function',insertText:'function ${1:name}(${2:params})\n\t$0\nend'},
  {label:'remote',insertText:'game:GetService("ReplicatedStorage"):WaitForChild("${1:RemoteName}").OnServerEvent:Connect(function(player, $2)\n\t$0\nend)'},
  {label:'datastore',insertText:'local DataStoreService = game:GetService("DataStoreService")\nlocal myDataStore = DataStoreService:GetDataStore("${1:DataName}")\n\nlocal success, errorMessage = pcall(function()\n\t$0\nend)'},
  {label:'raycast',insertText:'local params = RaycastParams.new()\nparams.FilterType = Enum.RaycastFilterType.Exclude\nlocal result = workspace:Raycast(${1:origin}, ${2:direction}, params)\nif result then\n\t$0\nend'},
  {label:'tween',insertText:'local TweenService = game:GetService("TweenService")\nlocal info = TweenInfo.new(${1:1})\nlocal tween = TweenService:Create(${2:object}, info, {${3:Property} = ${4:Value}})\ntween:Play()'}
];

const LUA_KEYWORDS=['local','function','if','then','elseif','else','for','while','repeat','until','do','end','return','break','continue','and','or','not','true','false','nil','in'];
const COMMON=['Destroy','Clone','FindFirstChild','WaitForChild','GetChildren','GetDescendants','IsA','Connect','Wait','Once','Disconnect','GetPropertyChangedSignal','SetAttribute','GetAttribute','IsDescendantOf','GetFullName','FindFirstAncestor'];

window.editorInstance = monaco.editor.create(document.getElementById('container'), {
    value: (tabs.find(t => t.id === activeTabId) || tabs[0]).content,
    language: 'lua', theme: 'vs-dark', fontSize: currentFontSize, automaticLayout: true,
    minimap: { enabled: true }, cursorSmoothCaretAnimation: true, smoothScrolling: true,
    wordWrap: "off", scrollbar: { vertical: 'visible', horizontal: 'visible', verticalScrollbarSize: 10, horizontalScrollbarSize: 10 },
    fixedOverflowWidgets: true, quickSuggestions: true, suggestOnTriggerCharacters: true,
    tabCompletion: "on", snippetSuggestions: "top"
});

async function saveState() {
    localStorage.setItem(TABS_KEY, JSON.stringify(tabs));
    localStorage.setItem(ACTIVE_ID_KEY, activeTabId.toString());
    localStorage.setItem(ZOOM_KEY, currentFontSize.toString());
    if (currentUser) {
        try {
            await db.doc(`artifacts/${appId}/users/${currentUser.uid}/data/state`).set({ tabs, activeTabId, lastSync: Date.now() }, { merge: true });
        } catch (e) { console.error("Sync error", e); }
    }
}

document.getElementById('zoom-in-btn').onclick = () => { currentFontSize += 2; window.editorInstance.updateOptions({fontSize:currentFontSize}); saveState(); };
document.getElementById('zoom-out-btn').onclick = () => { currentFontSize -= 2; window.editorInstance.updateOptions({fontSize:currentFontSize}); saveState(); };

window.switchTab = (id) => {
    if (id === activeTabId) return;
    const oldIndex = tabs.findIndex(t => t.id === activeTabId);
    const newIndex = tabs.findIndex(t => t.id === id);
    if(tabs[oldIndex]) tabs[oldIndex].content = window.editorInstance.getValue();
    const container = document.getElementById('container');
    container.className = 'slide-left-out';
    setTimeout(() => {
        activeTabId = id; window.editorInstance.setValue(tabs[newIndex].content);
        container.className = 'slide-left-in';
        saveState(); window.renderTabs();
        setTimeout(() => { container.className = ''; }, 200);
    }, 150);
};

document.getElementById('add-tab-btn').onclick = () => {
    const cur = tabs.find(t => t.id === activeTabId);
    if(cur) cur.content = window.editorInstance.getValue();
    const newId = Date.now();
    tabs.push({ id: newId, name: `Script ${tabs.length + 1}`, content: DEFAULT_CODE });
    activeTabId = newId; window.editorInstance.setValue(DEFAULT_CODE); window.renderTabs(); saveState();
};

window.editorInstance.onDidChangeModelContent(() => {
    const current = tabs.find(t => t.id === activeTabId);
    if (current) { current.content = window.editorInstance.getValue(); saveState(); }
});

/* Context Menu Logic */
const menu = document.getElementById('tab-menu');
window.showTabMenu = (id, x, y) => {
    targetTabId = id;
    document.getElementById('main-menu-group').style.display = 'block';
    document.getElementById('rename-section').style.display = 'none';
    menu.style.display = 'block';
    if (x + 180 > window.innerWidth) x -= 180;
    menu.style.left = x + 'px'; menu.style.top = y + 'px';
};
document.addEventListener('mousedown', (e) => { if (!menu.contains(e.target)) menu.style.display = 'none'; });

document.getElementById('menu-rename').onclick = () => {
    document.getElementById('main-menu-group').style.display = 'none';
    document.getElementById('rename-section').style.display = 'block';
    const tab = tabs.find(t => t.id === targetTabId);
    document.getElementById('inner-rename-input').value = tab.name;
    document.getElementById('inner-rename-input').focus();
};
document.getElementById('rename-cancel').onclick = (e) => { e.stopPropagation(); document.getElementById('main-menu-group').style.display = 'block'; document.getElementById('rename-section').style.display = 'none'; };
document.getElementById('rename-apply').onclick = (e) => {
    e.stopPropagation(); const name = document.getElementById('inner-rename-input').value.trim();
    if (name) { tabs.find(t => t.id === targetTabId).name = name; saveState(); window.renderTabs(); }
    menu.style.display = 'none';
};
document.getElementById('menu-delete').onclick = () => {
    menu.style.display = 'none'; tabs = tabs.filter(t => t.id !== targetTabId);
    if (tabs.length === 0) tabs = [{ id: Date.now(), name: 'MainScript', content: DEFAULT_CODE }];
    if (activeTabId === targetTabId) { activeTabId = tabs[0].id; window.editorInstance.setValue(tabs[0].content); }
    saveState(); window.renderTabs();
};

/* Ultimate Completion Provider */
monaco.languages.registerCompletionItemProvider('lua', {
  triggerCharacters: ['.', ':', '"', "'"],
  provideCompletionItems(model, pos) {
    const word = model.getWordUntilPosition(pos);
    const range = { startLineNumber: pos.lineNumber, endLineNumber: pos.lineNumber, startColumn: word.startColumn, endColumn: word.endColumn };
    const line = model.getLineContent(pos.lineNumber);
    const before = line.slice(0, pos.column);
    const m = before.match(/([\w\.:"'\(\)]+)([\.:])$/);
    if (m) {
      const type = m[1]; const colon = m[2] === ':';
      if (API[type]) {
        const out = []; if (!colon) API[type].props.forEach(p => out.push({ label: p, kind: monaco.languages.CompletionItemKind.Property, insertText: p, range }));
        API[type].methods.concat(COMMON).forEach(fn => out.push({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        return { suggestions: out };
      }
      if (DATA_TYPES[type]) {
        const d = DATA_TYPES[type]; const out = [];
        if (!colon) {
            d.props?.forEach(p => out.push({ label: p, kind: monaco.languages.CompletionItemKind.Property, insertText: p, range }));
            d.static?.forEach(s => out.push({ label: s, kind: monaco.languages.CompletionItemKind.Method, insertText: s + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        }
        d.methods?.forEach(fn => out.push({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
        return { suggestions: out };
      }
      if (LUA_LIBS[type] && !colon) return { suggestions: LUA_LIBS[type].methods.map(fn => ({ label: fn, kind: monaco.languages.CompletionItemKind.Method, insertText: fn + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range })) };
    }
    const suggestions = [];
    LUA_KEYWORDS.forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Keyword, insertText: k, range }));
    GLOBAL_FUNCS.forEach(f => suggestions.push({ label: f, kind: monaco.languages.CompletionItemKind.Function, insertText: f + '($0)', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
    SNIPPETS.forEach(s => suggestions.push({ label: s.label, kind: monaco.languages.CompletionItemKind.Snippet, insertText: s.insertText, insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }));
    Object.keys(API).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Class, insertText: k, range }));
    Object.keys(DATA_TYPES).forEach(k => suggestions.push({ label: k, kind: monaco.languages.CompletionItemKind.Struct, insertText: k, range }));
    return { suggestions };
  }
});

window.editorInstance.addAction({ id: 'download', label: 'Download Script (.txt)', contextMenuGroupId: 'navigation', run: (ed) => { const name = (tabs.find(t=>t.id===activeTabId).name) + ".txt"; const blob = new Blob([ed.getValue()], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); } });
window.editorInstance.addAction({ id: 'load-script', label: 'Load Script from Device', contextMenuGroupId: 'navigation', run: () => {
    const f = document.createElement('input'); f.type = 'file'; f.accept = '.lua, .txt';
    f.onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const r = new FileReader(); r.onload = (ev) => { 
            const cur = tabs.find(t => t.id === activeTabId);
            if (cur) { cur.content = ev.target.result; cur.name = file.name.split('.')[0]; window.editorInstance.setValue(cur.content); window.renderTabs(); saveState(); }
        }; r.readAsText(file);
    }; f.click();
}});
window.editorInstance.addAction({ id: 'format', label: 'Format Document', contextMenuGroupId: 'navigation', run: () => window.editorInstance.getAction('editor.action.formatDocument').run() });

window.addEventListener('resize', window.updateIndicator);
});

let defPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); defPrompt = e; if(!isStandalone) document.getElementById('install-app-btn').style.display = 'flex'; });
document.getElementById('install-app-btn').onclick = async () => { if (defPrompt) { defPrompt.prompt(); const { outcome } = await defPrompt.userChoice; if (outcome === 'accepted') defPrompt = null; } };
</script>
</body>
</html>

